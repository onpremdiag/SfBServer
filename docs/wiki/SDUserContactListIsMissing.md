# User contact list is not available
**Owner:** Robert Panduru

# Description

This scenario checks if Skype for Business user contact list is missing due account
being UCS (unified contact store) enabled however exchange connectivity is not
 available or not properly configured. For more details, please refer to
- [Configure Skype for Business Server to use the unified contact store](https://docs.microsoft.com/en-us/skypeforbusiness/deploy/integrate-with-exchange-server/use-the-unified-contact-store)

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDUserContactListIsMissing
%% Date Generated: 6/23/2021 10:06:59 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDSipAddress[\PDSipAddress\] -.-> SDUserContactListIsMissing

	SDUserContactListIsMissing(SDUserContactListIsMissing) --1--> ADCheckUserUCS[ADCheckUserUCS]

	ADCheckUserUCS -- 1.1 --> RDCheckUserUCSStatus[RDCheckUserUCSStatus]
	ADCheckUserUCS -- 1.2 --> RDCheckUserUCSConnectivity[RDCheckUserUCSConnectivity]

:::


# Rule specifications
### R1 - RDCheckUserUCSConnectivity
- Determine if user contact list can be effectively retrieved from Exchange Server<br/>
``` powershell
    $ServerFqdn = Resolve-DnsName -Name $env:COMPUTERNAME -Type A -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($ServerFqdn))
    {
        $ServerFqdnName = $ServerFqdn.Name

        if (-not [string]::IsNullOrEmpty($ServerFqdnName))
        {
            $PoolFqdn = Get-CsComputer -Identity $ServerFqdnName -ErrorAction SilentlyContinue

            if (-not [string]::IsNullOrEmpty($PoolFqdn.Pool))
            {
                $ucsStatus = Test-CsUnifiedContactStore -TargetFqdn $PoolFqdn.Pool -UserSipAddress $currentSipAddress -ErrorAction SilentlyContinue

                if (-not [string]::IsNullOrEmpty($ucsStatus))
                {
                    if ($ucsStatus.Result -eq "Failure")
                    {
                        $this.Success           = $false
                        $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name)
                        $this.Insight.Action    = $global:InsightActions.($this.Insight.Name)
                    }
                }
            }
            else
            {
                # Server Pool FQDN is null
                $this.Insight.Detection = $global:InsightDetections.'IDUnableToResolveServerFQDN'
                $this.Insight.Action    = $global:InsightActions.'IDUnableToResolveServerFQDN'
                $this.Success           = $false
            }
        }
        else
        {
            # Unable to resolve ServerFqdnName
            $this.Insight.Detection = $global:InsightDetections.'IDUnableToResolveServerFQDN'
            $this.Insight.Action    = $global:InsightActions.'IDUnableToResolveServerFQDN'
            $this.Success           = $false
        }
    }
    else
    {
        # Unable to Resolve-DnsName
        $this.Insight.Detection = $global:InsightDetections.'IDUnableToResolveDNSName'
        $this.Insight.Action    = $global:InsightActions.'IDUnableToResolveDNSName'
        $this.Success           = $false
    }
```

### R2 - RDCheckUserUCSStatus
- Determine if user account is enabled for unified contact store and user account has been migrated successfully<br/>
``` powershell
    $ucsStatus = Debug-CsUnifiedContactStore -Identity $currentSipAddress -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($ucsStatus))
    {
        if ($ucsStatus.UcsMode -eq "Disabled")
        {
            $this.Success           = $false

            $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f $currentSipAddress
            $this.Insight.Action    = $global:InsightActions.($this.Insight.Name)
        }
        if ($ucsStatus.UcsMode -eq "Ready To Migrate")
        {
            $this.Success           = $false

            $this.Insight.Detection = $global:InsightDetections.'IDUserUCSEnabledNotMigrated' -f $currentSipAddress
            $this.Insight.Action    = $global:InsightActions.'IDUserUCSEnabledNotMigrated'
        }

    }
    else
    {
        # SipAddress does not exist in UCS
        $this.Insight.Detection = $global:InsightDetections.'IDUserNotFound' -f $currentSipAddress
        $this.Insight.Action    = $global:InsightActions.'IDUserNotFound'
        $this.Success           = $false
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
<span style="color:green">[+] Verifies if target domain is approved for federation **-> Analyzer message**
&nbsp;&nbsp;&nbsp;&nbsp;[+] Determine if open federation is enabled or target domain is approved for federation **-> Rule message**</span>
<span style="color:red">[-] Verifies the on-premise domains configuration match Office 365 tenant domain configuration **-> Analyzer message**
&nbsp;&nbsp;&nbsp;&nbsp;[-] Determine if the on-premise domains configuration match Office 365 tenant domain configuration **-> Rule message**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-] Detection : The allowed federated domain configured in your On Premise environment, '[Domain not found]', and your O365 Tenant, 'domainnotinonprem.com', do not match. **-> Insight detection message**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-] Action : Please review Allowed domains list in the on-premises deployment as that must exactly match the Allowed domains list for your online tenant. For more information please refer to the following article https://docs.microsoft.com/en-us/skypeforbusiness/hybrid/plan-hybrid-connectivity. **-->Insight action message**</span>
(...)

### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDUserContactListIsMissing | User contact list is not available


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDSipAddress | The SIP address for the account. Commonly the same as the UPN | User SIP Address | user1@contoso.com | user@domain.contoso.com |


### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADCheckUserUCS | Verifies if user contact list is being accessed through Unified Contact Store|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckUserUCSConnectivity | Determine if user contact list can be effectively retrieved from Exchange Server |
| R2 | en-US | RDCheckUserUCSStatus | Determine if user account is enabled for unified contact store and user account has been migrated successfully |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDUnableToResolveDNSName | Unable to resolve DNS query for one or more of your Skype for Business Server server(s). |
| ID2 | en-US | IDUnableToResolveServerFQDN | Unable to resolve the FQDN for your Skype for Business Server. |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDUnableToResolveDNSName | Please confirm that 'Resolve-DnsName' cmdlet successfully performs a DNS query for each Edge Server in the Edge pool and each Frontend in the Frontend pool. |
| IA2 | en-US | IDUnableToResolveServerFQDN | Please execute 'Resolve-DnsName -Name $env:COMPUTERNAME -Type A' cmdlet and confirm valid output is returned. |
