# Check to verify Modern Authentication supportability and configuration
**Owner:** João Loureiro

# Description

**[TODO]**

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDModernAuthenticationNotWorking
%% Date Generated: 6/23/2021 10:06:57 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDSipAddress[\PDSipAddress\] -.-> SDModernAuthenticationNotWorking
	PDPromptforTeamsCreds[\PDPromptforTeamsCreds\] -.-> SDModernAuthenticationNotWorking

	SDModernAuthenticationNotWorking(SDModernAuthenticationNotWorking) --1--> ADCheckAADConfigured[ADCheckAADConfigured]

	ADCheckAADConfigured -- 1.1 --> RDCheckDirSyncEnabled[RDCheckDirSyncEnabled]
	SDModernAuthenticationNotWorking --2 --> ADCheckAllServersSkype[ADCheckAllServersSkype]

	ADCheckAllServersSkype -- 2.1 --> RDCheckForLyncServers[RDCheckForLyncServers]
	SDModernAuthenticationNotWorking --3 --> ADCheckDomainIsKnown[ADCheckDomainIsKnown]

	ADCheckDomainIsKnown -- 3.1 --> RDCheckSipDomainIsFederated[RDCheckSipDomainIsFederated]
	SDModernAuthenticationNotWorking --4 --> ADCheckModernAuthentication[ADCheckModernAuthentication]

	ADCheckModernAuthentication -- 4.1 --> RDCheckModernAuth[RDCheckModernAuth]
	ADCheckModernAuthentication -- 4.2 --> RDCheckTenantModernAuthEnabled[RDCheckTenantModernAuthEnabled]
	SDModernAuthenticationNotWorking --5 --> ADCheckO365Connectivity[ADCheckO365Connectivity]

	ADCheckO365Connectivity -- 5.1 --> RDCheckServicePoints[RDCheckServicePoints]
	SDModernAuthenticationNotWorking --6 --> ADCheckRegistrarVersions[ADCheckRegistrarVersions]

	ADCheckRegistrarVersions -- 6.1 --> RDCheckServerVersion[RDCheckServerVersion]

:::


# Rule specifications
### R1 - RDCheckDirSyncEnabled
- Determine if Directory Sync is enabled<br/>
``` powershell
	$CsTenant = Get-CsTenant -WarningAction SilentlyContinue

	if (-not [string]::IsNullOrEmpty($CsTenant))
	{
		$this.Success = $CsTenant.DirSyncEnabled
	}
	else
	{
		throw 'IDGetCsTenantFails'
	}
```

### R2 - RDCheckForLyncServers
- Determine if there are any Lync servers in the topology<br/>
``` powershell
    if (@(Get-CSService | Where-Object {$_.Version -lt 7}).Count -ne 0)
    {
        throw 'IDLyncServerFound'
    }
```

### R3 - RDCheckModernAuth
- Determine if Legacy modern authentication is being used<br/>
``` powershell
    $command = Get-Command -Module $global:SfBServerModule -Name Get-CsOauthConfiguration

    if (-not [string]::IsNullOrEmpty($command))
    {
        $Configuration = & $command
    }
    else
    {
        $Configuration = $null
    }

    if (-not [string]::IsNullOrEmpty($Configuration))
    {
        $Servers = $Configuration.OAuthServers

        if (-not [string]::IsNullOrEmpty($Servers))
        {
            foreach ($stsServer in $Servers)
            {
                if ($stsServer.IssuerIdentifier -eq 'sts.windows.net')
                {
                    $LegacyAuthFound = $true
                    break
                }
            }
        }
        else
        {
            throw 'IDNotOAuthServers'
        }
    }
    else
    {
        throw 'IDUnableToGetOAuthConfiguration'
    }

    if ($LegacyAuthFound -and -not ($this.IsSharedAddressSpaceEnabled()))
    {
        # error
        throw 'IDModernAuthMismatch'
    }
    elseif (-not $LegacyAuthFound -and $this.IsSharedAddressSpaceEnabled())
    {
        # error
        throw 'IDModernAuthMismatch'
    }
    else
    {
        # warning
        throw 'IDLegacyModernAuthDetected'
    }
```

### R4 - RDCheckServerVersion
- Determine if the current product version is compatible with the Web Component Server<br/>
``` powershell
    # Let's get the current server version. This will give us our baseline for comparison
    $CurrentProduct = Get-CsServerVersion

    if (-not [string]::IsNullOrEmpty($CurrentProduct))
    {
        if ($CurrentProduct -match "^(?:.*\()(?<Version>\d+\.\d+\.\d+\.\d+)\).*$")
        {
            $BaselineVersion = $Matches.Version
        }
        else
        {
            throw 'IDUnableToGetVersion'
        }

        $ServerVersion = Get-CsServerPatchVersion | Where-Object {$_.ComponentName -like "*Web Components Server*"}

        if (-not [string]::IsNullOrEmpty($ServerVersion))
        {
            if (([System.Version]$ServerVersion.Version).CompareTo([System.Version]$BaselineVersion) -ge 0)
            {
                break
            }
            else
            {
                throw 'IDIncorrectServerVersion'
            }
        }
        else
        {
            throw 'IDUnableToGetVersion'
        }
    }
    else
    {
        throw 'IDUnableToGetVersion'
    }
```

### R5 - RDCheckServicePoints
- Determine if TLS connectivity to O365 and CRLs reachable<br/>
``` powershell
    New-Variable -Name O365ServicePoints `
                 -Value @("https://adminwebservice.microsoftonline.com","https://login.microsoft.com") `
                 -Scope 'Global' `
                 -Description 'O365 Service Endpoints' `
                 -Force

    New-Variable -Name O365CRLs `
                 -Value @("https://crl.microsoft.com","https://mscrl.microsoft.com") `
                 -Scope 'Global' `
                 -Description 'O365 Certificate Revocation Lists' `
                 -Force

    foreach ($url in @($global:O365ServicePoints+$global:O365CRLs))
    {
        if (-not (Test-CertificateSubject -Url $url))
        {
            throw 'IDCertificateSubjectMissing'
        }
    }
```

### R6 - RDCheckSipDomainIsFederated
- Determine if the SIP domain is federated/managed<br/>
``` powershell
    $Response = Invoke-WebRequest -Uri "https://login.microsoftonline.com/getuserrealm.srf?Login=$($SipAddress)" | ConvertFrom-Json

    if (-not [string]::IsNullOrEmpty($Response))
    {
        if ($Response.NameSpaceType -ne 'Managed' -and $Response.NameSpaceType -ne 'Federated')
        {
            throw 'IDSipDomainNotFederated'
        }
    }
```

### R7 - RDCheckTenantModernAuthEnabled
- Determine if Modern Authentication is enabled<br/>
``` powershell
    if ($this.IsSharedAddressSpaceEnabled())
    {
        $OAuthConfiguration = Get-CsOauthConfiguration -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($OAuthConfiguration))
        {
            $ClientAdalAuthOverride = $OAuthConfiguration.Element.Attribute('ClientAdalAuthOverride').Value

            if (-not [string]::IsNullOrEmpty($ClientAdalAuthOverride) -and $ClientAdalAuthOverride -ne 'Allowed')
            {
                throw 'IDModernAuthNotEnabled'
            }
        }
        else
        {
            throw 'IDUnableToGetOAuthConfiguration'
        }
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDModernAuthenticationNotWorking | Skype for Business Modern Authentication is not working


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDPromptforTeamsCreds |  | Next you will be prompted for Teams Administrator/Global Administrator credentials. Please press Enter to continue |  |
| P2 | en-US | PDSipAddress | The SIP address for the account. Commonly the same as the UPN | User SIP Address | user1@contoso.com | user@domain.contoso.com |


### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADCheckAADConfigured | Verifies if the Azure Active Directory (AAD) connection is properly configured|
| A2 | en-US | ADCheckAllServersSkype | Verifies that all the registrars in the topology are Skype for Business 2015 or later|
| A3 | en-US | ADCheckDomainIsKnown | Verifies that the user's domain is registered with Azure Active Directory (AAD)|
| A4 | en-US | ADCheckModernAuthentication | Verifies if Modern Authentication has been enabled|
| A5 | en-US | ADCheckO365Connectivity | Verifies that the connectivity from the registrar to required O365 URLs is available|
| A6 | en-US | ADCheckRegistrarVersions | Verifies that the Skype for Business servers are at the proper version|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckDirSyncEnabled | Determine if Directory Sync is enabled |
| R2 | en-US | RDCheckForLyncServers | Determine if there are any Lync servers in the topology |
| R3 | en-US | RDCheckModernAuth | Determine if Modern Authentication is being used |
| R4 | en-US | RDCheckServerVersion | Determine if the current product version is compatible with the Web Component Server |
| R5 | en-US | RDCheckServicePoints | Determine if TLS connectivity to O365 and CRLs reachable |
| R6 | en-US | RDCheckSipDomainIsFederated | Determine if the SIP domain is federated/managed |
| R7 | en-US | RDCheckTenantModernAuthEnabled | Determine if Tenant Modern Authentication is enabled |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDCertificateSubjectMissing | Cannot verify Microsoft 365 Certificate Revocation Lists URLs. |
| ID2 | en-US | IDClientOAuthDisabled | Hybrid Modern Authentication is not enabled. |
| ID3 | en-US | IDDoNotAllowSharedSipAddressSpace | Office 365 Tenant shared SIP address space is disabled. |
| ID4 | en-US | IDGetCsTenantFails | Unable to detect specified domain in Microsoft 365 cloud-based services. |
| ID5 | en-US | IDIncorrectServerVersion | Server version mis-match. Expected {0} or higher but found {1}. |
| ID6 | en-US | IDLegacyModernAuthDetected | The server is using legacy Modern Authentication, which is not recommended. |
| ID7 | en-US | IDLyncServerFound | No Skype for Business Servers services were found in your topology. |
| ID8 | en-US | IDModernAuthNotEnabled | EvoSTS Authorization Server Object is missing. |
| ID9 | en-US | IDModernAuthSfboNotEnabled | Tenant Modern authentication is not configured. Expected ClientAdalAuthOverride value '{0}' but found '{1}'. |
| ID10 | en-US | IDNotOAuthServers | Get-CsOAuthConfiguration cmdlet returned an empty output. |
| ID11 | en-US | IDSipDomainNotFederated | The specified user domain is not a verified Microsoft 365 domain. |
| ID12 | en-US | IDUnableToGetOAuthConfiguration | Get-CsOAuthConfiguration cmdlet returned an error or an empty output. |
| ID13 | en-US | IDUnableToGetVersion | Unable to determine current patch level on the server. |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDCertificateSubjectMissing | Please confirm if Microsoft 365 Certificate Revocation Lists URLs https://crl.microsoft.com and https://mscrl.microsoft.com are reachable. |
| IA2 | en-US | IDClientOAuthDisabled | Please run this command in the Skype for Business Management Shell: Set-CsOAuthConfiguration -ClientAuthorizationOAuthServerIdentity evoSTS. |
| IA3 | en-US | IDDoNotAllowSharedSipAddressSpace | Please enable Office 365 Tenant shared SIP address space. For more information please refer to the following article https://docs.microsoft.com/skypeforbusiness/hybrid/configure-federation-with-skype-for-business-online. |
| IA4 | en-US | IDGetCsTenantFails | Please verify that specified Microsoft 365 default domain has been setup. For more details please refer to the following guidance: https://docs.microsoft.com/microsoft-365/admin/setup/setup. |
| IA5 | en-US | IDIncorrectServerVersion | Please upgrade Skype for Business Server Web Components to match current Skype for Business Server edition. Please compare Get-CsServerPatchVersion and Get-CsServerVersion cmdlet output and confirm baseline version matches. |
| IA6 | en-US | IDLegacyModernAuthDetected | Please configure your On-Premise environment for hybrid modern authentication, as described in https://docs.microsoft.com/microsoft-365/enterprise/configure-skype-for-business-for-hybrid-modern-authentication. |
| IA7 | en-US | IDLyncServerFound | Please open Skype for Business Server Topology Builder and confirm topology can be successfully loaded. |
| IA8 | en-US | IDModernAuthNotEnabled | Please create the EvoSTS Authentication Server Object, as described in https://docs.microsoft.com/microsoft-365/enterprise/configure-skype-for-business-for-hybrid-modern-authentication. |
| IA9 | en-US | IDModernAuthSfboNotEnabled | Please enable modern authentication for Skype for Business online. For more details please refer to the following guidance https://social.technet.microsoft.com/wiki/contents/articles/34339.skype-for-business-online-enable-your-tenant-for-modern-authentication.aspx. |
| IA10 | en-US | IDNotOAuthServers | Please review Skype for Business Hybrid modern authentication configuration steps. For more details please refer to the following article https://docs.microsoft.com/microsoft-365/enterprise/hybrid-modern-auth-overview |
| IA11 | en-US | IDSipDomainNotFederated | Please add the specified user domain as a Microsoft 365 verified domain. |
| IA12 | en-US | IDUnableToGetOAuthConfiguration | Please review Skype for Business Hybrid modern authentication configuration steps. For more details please refer to the following article https://docs.microsoft.com/microsoft-365/enterprise/hybrid-modern-auth-overview |
| IA13 | en-US | IDUnableToGetVersion | Please verify if Get-CsServerVersion cmdlet returns a valid output. |
