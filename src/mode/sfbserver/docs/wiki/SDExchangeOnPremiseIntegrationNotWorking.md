# Checks the integration between Skype for Business Server and Exchange OnPrem deployment
**Owner:** João Loureiro

# Description

**[TODO]**

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDExchangeOnPremiseIntegrationNotWorking
%% Date Generated: 6/23/2021 10:06:56 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDSipAddress[\PDSipAddress\] -.-> SDExchangeOnPremiseIntegrationNotWorking
	PDExchangeServer[\PDExchangeServer\] -.-> SDExchangeOnPremiseIntegrationNotWorking

	SDExchangeOnPremiseIntegrationNotWorking(SDExchangeOnPremiseIntegrationNotWorking) --1--> ADExchangeOnPremise[ADExchangeOnPremise]

	ADExchangeOnPremise -- 1.1 --> RDExchangePowerShellCmdletsLoaded[RDExchangePowerShellCmdletsLoaded]
	ADExchangeOnPremise -- 1.2 --> RDTestAutoDiscover[RDTestAutoDiscover]
	ADExchangeOnPremise -- 1.3 --> RDAutoDiscoverServiceInternalUri[RDAutoDiscoverServiceInternalUri]
	ADExchangeOnPremise -- 1.4 --> RDExchangeAutodiscoverUrl[RDExchangeAutodiscoverUrl]
	ADExchangeOnPremise -- 1.5 --> RDCsPartnerApplication[RDCsPartnerApplication]
	ADExchangeOnPremise -- 1.6 --> RDTestExchangeConnectivity[RDTestExchangeConnectivity]

:::


# Rule specifications
### R1 - RDAutoDiscoverServiceInternalUri
- Determine if the AutoDiscoverServiceInternalUri value contains a valid configuration<br/>
``` powershell
    $expectedValue = '/Autodiscover/Autodiscover.xml'

    $ClientAccessService = Get-ClientAccessService -Identity EXCHANGE

    if (-not [string]::IsNullOrEmpty($ClientAccessService))
    {
        if ($ClientAccessService.AutoDiscoverServiceInternalUri -notlike "*$($expectedValue)*")
        {
            # Wrong AutoDiscoverServiceInternalUri configuration
            throw 'IDBadAutoDiscoverServiceInternalUri'
        }
    }
    else
    {
        # No value returned for client access server role
        throw 'IDNoClientAccessServerRole'
    }
```

### R2 - RDCsPartnerApplication
- Determine if the partner application exists and is configured with the proper value<br/>
``` powershell
    $expectedValue              = "/Autodiscover/metadata/json/1"

    try
    {
        $PartnerApplication = Get-CsPartnerApplication -Identity EXCHANGE -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($PartnerApplication))
        {
            if ($PartnerApplication.AuthToken -notlike "*$($expectedValue)")
            {
                # wrong metadaturl configuration
                throw 'IDWrongMetadataUrlConfiguration'
            }
        }
        else
        {
            # unable to get partner application information
            throw 'IDNoPartnerApplication'
        }
    }
```

### R3 - RDExchangeAutodiscoverUrl
- Determine if the OAuth ExchangeAutodiscoverUrl is well configured<br/>
``` powershell
    $expectedValue              = "/Autodiscover/Autodiscover.svc"

    try
    {
        $oAuthConfiguration = Get-CsOAuthConfiguration

        if (-not [string]::IsNullOrEmpty($oAuthConfiguration))
        {
            if ($oAuthConfiguration.ExchangeAutodiscoverUrl -notlike "*$($expectedValue)*")
            {
                # Not well configured for exchange on-premises
                throw 'IDExchangeAutodiscoverUrlNotConfigured'
            }
        }
        else
        {
            # No oAuth config information returned
            throw 'IDNoOauthConfigurationFound'
        }
    }
```

### R4 - RDExchangePowerShellCmdletsLoaded
- Determine if the Exchange cmdlets are loaded. If not, load them.<br/>
``` powershell
    # Let's see if we've already got the cmdlets (Exchange) that we need access to
    if (-not (Get-Command -Name Get-ClientAccessService -ErrorAction SilentlyContinue))
    {
        $session = New-PSSession -ConfigurationName Microsoft.Exchange `
                                    -ConnectionUri "http://$($obj.ExchangeServer)/PowerShell" `
                                    -Authentication Kerberos `
                                    -Credential $obj.Credential `
                                    -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($session))
        {
            # Import commands from the Exchange Session
            $remoteSession = Import-RemoteSession -Session $Session

            if (-not [string]::IsNullOrEmpty($remoteSession))
            {
                # Did we import the command(s)? Let's check
                if (-not ($remoteSession.ExportedCommands | Where-Object {$_.Keys -eq 'Get-ClientAccessService'}))
                {
                    throw 'IDUnableToImportExchangeCmdlets'
                }
            }
            else
            {
                throw 'IDUnableToImportRemoteSession'
            }
        }
        else
        {
            throw 'IDNoSession'
        }
    }
```

### R5 - RDTestAutoDiscover
- Determine if the DNS name for the Autodiscover is resolvable<br/>
``` powershell
    $domainName               = $env:USERDNSDOMAIN
    $expectedAutoDiscoverName = "autodiscover.$domainName"
    $actualServerName         = $expectedAutoDiscoverName

    if (-not [string]::IsNullOrEmpty($domainName))
    {

        $autoDiscoverCNAMERecord = Resolve-DnsName -Name $expectedAutoDiscoverName -Server 8.8.8.8 -Type CNAME -ErrorAction SilentlyContinue
        $autoDiscoverARecord     = Resolve-DnsName -Name $actualServerName -Server 8.8.8.8 -Type A -ErrorAction SilentlyContinue |
                                    Where-Object {$_.Type -eq 'A'}

        if (-not [string]::IsNullOrEmpty($autoDiscoverCNAMERecord))
        {
            $actualServerName = $autoDiscoverCNAMERecord.NameHost

            if (-not $actualServerName.EndsWith($domainName,'CurrentCultureIgnoreCase'))
            {
                # CNAME record does not respect strict name matching
                throw 'IDAutoDiscoverNameDoNotMatch'
            }
        }
                elseif ([string]::IsNullOrEmpty($autoDiscoverARecord))
                {
                    # Possible missing DNS record
                    throw 'IDDNSNameDoesNotExist'
                }
            }
            else
            {
                # unable to determine domain name from the environment variable
                throw 'IDUnknownDomain'
            }
```

### R6 - RDTestExchangeConnectivity
- Determine if the Skype for Business Server Storage Service is working on a Front End Server<br/>
``` powershell
    $currentSipAddress = Get-ParameterDefinition -Object $this -ParameterName 'PDSipAddress'

    if (-not [string]::IsNullOrEmpty($currentSipAddress))
    {
        $connectivity = Test-CsExStorageConnectivity -SipUri $currentSipAddress -ErrorAction SilentlyContinue

        if ($connectivity -notlike '*passed*')
        {
            # Test failed
            throw 'IDNoExchangeConnectivity'
        }
    }
    else
    {
        # no sip address found - we shouldn't hit this
        throw 'IDNoSIPAddress'
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)

### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDExchangeOnPremiseIntegrationNotWorking | Skype for Business Server and Exchange On-Premises deployment integration is not working


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDExchangeServer | Fully qualified domain name (FQDN) of the Exchange server | Exchange server name | exchange.contoso.com |
| P2 | en-US | PDSipAddress | The SIP address for the account. Commonly the same as the UPN | User SIP Address | user1@contoso.com | user@domain.contoso.com |


### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADExchangeOnPremise | Verifies that connectivity with Exchange On-Premise is configured correctly|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDAutoDiscoverServiceInternalUri | Determine if the AutoDiscoverServiceInternalUri value contains a valid configuration |
| R2 | en-US | RDCsPartnerApplication | Determine if the partner application exists and is configured with the proper value |
| R3 | en-US | RDExchangeAutodiscoverUrl | Determine if the OAuth ExchangeAutodiscoverUrl is well configured |
| R4 | en-US | RDExchangePowerShellCmdletsLoaded | Determine if the Exchange cmdlets are loaded. If not, load them. |
| R5 | en-US | RDTestAutoDiscover | Determine if the DNS name for the Autodiscover is resolvable |
| R6 | en-US | RDTestExchangeConnectivity | Determine if the Skype for Business Server Storage Service is working on a Front End Server |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDAutoDiscoverNameDoNotMatch | Autodiscover DNS CNAME record '{0}' points to a DNS A record. '{1}' is not respecting domain strict name matching |
| ID2 | en-US | IDBadAutoDiscoverServiceInternalUri | The wrong configuration was found for the AutoDiscoverServiceInternalUri. Expected '{0}' but found '{1}' |
| ID3 | en-US | IDDNSNameDoesNotExist | The DNS name, '{0}', does not appear to exist |
| ID4 | en-US | IDExchangeAutodiscoverUrlNotConfigured | Autodiscover URL is not well formed for Exchange On-Premise. Expected '{0}' but got '{1}' |
| ID5 | en-US | IDNoClientAccessServerRole | Unable to determine the client access server role for the Exchange service |
| ID6 | en-US | IDNoExchangeConnectivity | Test-CsExStorageConnectivity cmdlet that verifies if Skype for Business Server Storage service can communicate with Exchange Server failed for SIP user {0} |
| ID7 | en-US | IDNoOauthConfigurationFound | Unable to obtain Exchange AutodiscoverUrl value. |
| ID8 | en-US | IDNoPartnerApplication | Unable to locate Exchange partner application information. |
| ID9 | en-US | IDNoSession | Unable to establish a connection with '{0}' |
| ID10 | en-US | IDNoSIPAddress | Lookup failed to find '{0}' SIP user. |
| ID11 | en-US | IDUnableToImportExchangeCmdlets | Unable to import the Exchange cmdlets from the Exchange server '{0}'. |
| ID12 | en-US | IDUnableToImportRemoteSession | Unable to establish a remote session with server '{0}' |
| ID13 | en-US | IDUnknownDomain | Unable to determine the user DNS domain |
| ID14 | en-US | IDWrongMetadataUrlConfiguration | Wrong partner application AuthToken Metadata configuration detected. Expected '{0}' but got '{1}' |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDAutoDiscoverNameDoNotMatch | Please confirm that '{0}' CNAME record points to a DNS record within same domain complying with strict name matching. For more details, please refer to the following article: https://docs.microsoft.com/exchange/architecture/client-access/autodiscover?view=exchserver-2019. |
| IA2 | en-US | IDBadAutoDiscoverServiceInternalUri | Please verify and correct AutoDiscoverServiceInternalUri configuration using Set-ClientAccessServer cmdlet. |
| IA3 | en-US | IDDNSNameDoesNotExist | Please verify that the domain name, '{0}', is correct and attempt this operation again. |
| IA4 | en-US | IDExchangeAutodiscoverUrlNotConfigured | Please refer to the following for guidance: https://blog.schertz.name/2015/09/exchange-and-skype-for-business-integration/ |
| IA5 | en-US | IDNoClientAccessServerRole | Please review the client access server role Exchange service using Get-ClientAccessServer cmdlet. |
| IA6 | en-US | IDNoExchangeConnectivity | Please refer to the following for guidance: https://blog.schertz.name/2015/09/exchange-and-skype-for-business-integration/ |
| IA7 | en-US | IDNoOauthConfigurationFound | Please refer to the following guidance: https://docs.microsoft.com/skypeforbusiness/plan-your-deployment/integrate-with-exchange/integrate-with-exchange |
| IA8 | en-US | IDNoPartnerApplication | Please refer to the following guidance: https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA9 | en-US | IDNoSession | Please verify that the username and/or password supplied are correct and retry |
| IA10 | en-US | IDNoSIPAddress | Please verify that SIP user {0} is SIP enabled and have an associated mailbox. |
| IA11 | en-US | IDUnableToImportExchangeCmdlets | Please verify if remote Exchange PowerShell control for server '{0}' is allowed. For more details please refer to the following article: https://docs.microsoft.com/powershell/exchange/control-remote-powershell-access-to-exchange-servers?view=exchange-ps |
| IA12 | en-US | IDUnableToImportRemoteSession | Please verify if remote Exchange PowerShell control for server '{0}' is allowed. For more details please refer to the following article: https://docs.microsoft.com/powershell/exchange/control-remote-powershell-access-to-exchange-servers?view=exchange-ps |
| IA13 | en-US | IDUnknownDomain | Please confirm if $env:USERDNSDOMAIN environment variable points to correct user local domain |
| IA14 | en-US | IDWrongMetadataUrlConfiguration | Please refer to the following guidance: https://docs.microsoft.com/skypeforbusiness/deploy/integrate-with-exchange-server/configure-partner-applications |
