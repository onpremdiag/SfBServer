# Skype for Business Server deployment best practices
**Owner:** João Loureiro

# Description

This scenario checks if the Skype for Business Server is following the
Best Practices. For more details please refer to the following articles: **TO_DO**

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDBestPractices
%% Date Generated: 6/23/2021 10:06:56 AM
%% This file is autogenerated. Please do not edit directly
%%


	SDCheckSfbServerSupportability(SDCheckSfbServerSupportability) --1--> ADBestPractices[ADBestPractices]

	ADBestPractices -- 1.1 --> RDCheckAddressInPool[RDCheckAddressInPool]
	ADBestPractices -- 1.2 --> RDCheckListenAll[RDCheckListenAll]
	ADBestPractices -- 1.3 --> RDCheckMultihomedServer[RDCheckMultihomedServer]
	ADBestPractices -- 1.4 --> RDCheckPatchVersion[RDCheckPatchVersion]
	ADBestPractices -- 1.5 --> RDCheckSQLLogs[RDCheckSQLLogs]
	ADBestPractices -- 1.6 --> RDDuplicatesInTrustedRootCA[RDDuplicatesInTrustedRootCA]

:::


# Rule specifications
### R1 - RDCheckAddressInPool
- Determine if current machine is in list of addresses for the pool<br/>
``` powershell
    $ServerFqdn = Resolve-DnsName -Name $env:COMPUTERNAME -Type A -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($ServerFqdn))
    {
        $PoolFqdn = Get-CsComputer -Identity $ServerFqdn.Name -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($PoolFqdn))
        {
            $PoolIPAddressList = @(Resolve-DnsName -Name $PoolFqdn.Pool -Type A -ErrorAction SilentlyContinue)

            if (-not [string]::IsNullOrEmpty($PoolIPAddressList))
            {
                if ($PoolIPAddressList.IPAddress -notcontains $ServerFqdn.IPAddress)
                {
                    throw 'IDIPAddressNotInPool'
                }
            }
            else
            {
                throw 'IDNoPoolIPAddresses'
            }
        }
        else
        {
            throw 'IDUnableToGetServiceInfo'
        }
    }
    else
    {
        throw 'IDUnableToResolveDNSName'
    }
```

### R2 - RDCheckListenAll
- Determine if the server is configured to listen on all IP Addresses<br/>
``` powershell
    $ListenAllFound = (Get-NetTCPConnection -LocalPort 5061 -State Listen).LocalAddress -eq "0.0.0.0"

    if (-not $ListenAllFound)
    {
        throw 'IDListenAllNotFound'
    }
```

### R3 - RDCheckMultihomedServer
- Determine if the server is multi-homed<br/>
``` powershell
    $ServerFqdn = Resolve-DnsName -Name $env:COMPUTERNAME -Type A -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($ServerFqdn))
    {
        $ServerFqdnName = $ServerFqdn.Name

        if (-not [string]::IsNullOrEmpty($ServerFqdnName))
        {
            $IPAddress = (Resolve-DnsName -Name $ServerFqdnName -Type A).IPAddress

            if (-not [string]::IsNullOrEmpty($IPAddress))
            {
                $count = @(Get-NetIPAddress -IPAddress $IPAddress -AddressFamily IPv4 -Type Unicast |
                                        Where-Object {$_.PrefixOrigin -ne 'WellKnown'}).Count

                if ($count -gt 1)
                {
                    # What is the WARNING/ERROR condition??
                    # 1 is good, >1 => WARNING
                    # ID: multi-homed detected machine. Not supported configuration
                    # IA: Point them to KB article
                    throw 'IDMultiHomePossible'
                }
            }
            else
            {
                throw 'IDUnableToResolveDNSName'
            }
        }
        else
        {
            throw 'IDUnableToResolveServerFQDN'
        }
    }
    else
    {
        throw 'IDUnableToResolveDNSName'
    }
```

### R4 - RDCheckPatchVersion
- Determine if the server is at, or above, currently recommended patch level(s)<br/>
``` powershell
    # Determine which version we're running
    $CurrentProduct = Get-CsServerVersion
    if(-not [string]::IsNullOrEmpty($CurrentProduct))
    {
        $ProductName = $global:SkypeForBusinessUpdates |
                            ForEach-Object {$_.ProductName} |
                            Sort-Object -Unique |
                            Where-Object {$CurrentProduct.Contains($_)}

        if(-not [string]::IsNullOrEmpty($ProductName))
        {
            $expectedPatches = $global:SkypeForBusinessUpdates | Where-Object {$_.ProductName -eq $ProductName}
            $actualPatches   = Get-csServerPatchVersion

            foreach($patch in $actualPatches)
            {
                $patchFound = $expectedPatches | Where-Object {$_.ComponentName -eq ($patch.ComponentName.Split(',')[1].TrimStart(' '))}

                if (-not [string]::IsNullOrEmpty($patchFound))
                {
                    if (([System.Version]$patch.Version).CompareTo($patchFound.Version) -ge 0)
                    {
                        break
                    }
                    else
                    {
                        throw 'IDPatchUpdateAvailable'
                    }
                }
            }
        }
        else
        {
            throw 'IDUnableToGetProductName'
        }
    }
    else
    {
        throw 'IDUnableToGetVersion'
    }
```

### R5 - RDCheckSQLLogs
- Determine if the SQL server transaction logs are too large<br/>
``` powershell
    $ServerFqdn = Resolve-DnsName -Name $env:COMPUTERNAME -Type A -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($ServerFqdn))
    {
        $ServerFqdnName = $ServerFqdn.Name
        if (-not [string]::IsNullOrEmpty($ServerFqdnName))
        {
            if ($ServerFqdnName -is [array])
            {
                $ServerFqdnName = $ServerFqdnName[0]
            }

            $PoolFqdn = Get-CsComputer -Identity $ServerFqdnName -ErrorAction SilentlyContinue

            if (-not [string]::IsNullOrEmpty($PoolFqdn))
            {
                $Service = Get-CsService -UserServer -PoolFqdn $PoolFqdn.Pool -ErrorAction SilentlyContinue

                if (-not [string]::IsNullOrEmpty($Service))
                {
                    $BackendFqdn = $Service.UserDatabase.split(":")[1]

                    if(-not [string]::IsNullOrEmpty($BackendFqdn))
                    {
                        $csRemoteDatabases = Test-CsDatabase -ConfiguredDatabases `
                                                                -SqlServerFqdn $BackendFqdn `
                                                                -ErrorAction SilentlyContinue `
                                                                -WarningAction SilentlyContinue
                        if (-not [string]::IsNullOrEmpty($csRemoteDatabases))
                        {
                            foreach ($remoteDatabase in ($csRemoteDatabases | Where-Object {$_.DatabaseName -eq 'rtcxds'}))
                            {
                                $logSpace = Invoke-SqlCmd -ServerInstance $remoteDatabase.DataSource `
                                                -Query 'DBCC SQLPERF(logspace)'

                                if (-not [string]::IsNullOrEmpty($logSpace))
                                {
                                    $logSpaceUsed = ($logSpace | Where-Object {$_.'Database Name' -eq 'rtcxds'}).'Log Space Used (%)'

                                    if ($logSpaceUsed -gt $global:SQLLogSpaceThreshold)
                                    {
                                        throw 'IDLogSpaceThreshold'
                                    }
                                }
                                else
                                {
                                    throw 'IDNoLogSpace'
                                }
                            }
                        }
                        else
                        {
                            throw 'IDTestCsDatabaseNoResults'
                        }
                    }
                }
                else
                {
                    throw 'IDUnableToGetServiceInfo'
                }
            }
            else
            {
                throw 'IDUnableToGetServiceInfo'
            }
        }
        else
        {
            throw 'IDUnableToResolveServerFQDN'
        }
    }
    else
    {
        throw 'IDUnableToResolveDNSName'
    }

```

### R6 - RDDuplicatesInTrustedRootCA
- Determine if there are duplicate certificates in the trusted root certification authority<br/>
``` powershell
    if (Test-Path -Path $global:LocalMachineCertificateStore)
    {
        $DuplicateCerts = Get-ChildItem -Path $global:LocalMachineCertificateStore |
                            Group-Object -Property Thumbprint |
                            Where-Object {$_.Count -gt 1} |
                            Select-Object -ExpandProperty Group |
                            Select-Object -Property Thumbprint, FriendlyName, Issuer, Subject

        if (-not [string]::IsNullOrEmpty($DuplicateCerts))
        {
            throw 'IDDuplicatesInTrustedRootCA'
        }
    }
    else
    {
        throw 'IDLocalCertStoreNotFound'
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description<br/>
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-us | SDCheckSfbServerSupportability | Skype for Business Server deployment best practices




### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADBestPractices | Verifies server is configured with the latest updates, recommendations and best practices|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckAddressInPool | Determine if current machine is in list of addresses for the pool |
| R2 | en-US | RDCheckListenAll | Determine if the server is configured to listen on all IP Addresses |
| R3 | en-US | RDCheckMultihomedServer | Determine if the server is multi-homed |
| R4 | en-US | RDCheckPatchVersion | Determine if the server is at, or above, currently recommended patch level(s) |
| R5 | en-US | RDCheckSQLLogs | Determine if the SQL server transaction logs are too large |
| R6 | en-US | RDDuplicatesInTrustedRootCA | Determine if there are duplicate certificates in the trusted root certification authority |

### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDDuplicatesInTrustedRootCA | The following duplicate(s) were found: FriendlyName: '{0}', Issuer: '{1}', Subject: '{2}', Thumbprint: {3} |
| ID2 | en-US | IDIPAddressNotInPool | Unable to locate local machine's IP address, {0}, in list of addresses, {1}, associated with Pool FQDN |
| ID3 | en-US | IDListenAllNotFound | Server isn?t configured to listen on all IP Addresses. |
| ID4 | en-US | IDLocalCertStoreNotFound | The local machine certificate store is either missing or unavailable. |
| ID5 | en-US | IDLogSpaceThreshold | SQL server transaction logs on {0} at {1} are exceeding warning threshold. Expected a value of {2}% or less, actual value is {3}% |
| ID6 | en-US | IDMultiHomePossible | A possible multi-home configuration was found. We expected to get a count of 1 IP address bound to the NIC but found {0} instead. |
| ID7 | en-US | IDNoLogSpace | Not able to identify available transaction log space for database {1} associated to {0} data source. |
| ID8 | en-US | IDNoPoolIPAddresses | Unable to resolve Frontend End pool FQDN IP DNS records. |
| ID9 | en-US | IDPatchUpdateAvailable | Out of date component found: {0} - Found {1} but {2} is available |
| ID10 | en-US | IDTestCsDatabaseNoResults | Unable to verify connectivity to one or more Skype for Business Server databases. |
| ID11 | en-US | IDUnableToGetProductName | Unable to locate 'Core Component' |
| ID12 | en-US | IDUnableToGetServiceInfo | Unable to get information about the services and server roles being used in your Skype for Business Server infrastructure. |
| ID13 | en-US | IDUnableToGetVersion | Unable to determine current patch level on the server. |
| ID14 | en-US | IDUnableToResolveDNSName | Unable to resolve DNS query for one or more of your Skype for Business Server server(s). |
| ID15 | en-US | IDUnableToResolveServerFQDN | Unable to resolve the FQDN for your Skype for Business Server. |

### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDDuplicatesInTrustedRootCA | Please remove duplicate entries from {0} |
| IA2 | en-US | IDIPAddressNotInPool | In case DNS Load balancing is being Frontend IP address is required  to be added to the Pool DNS Record. Note: If hardware load balancing, this may be a false positive. |
| IA3 | en-US | IDListenAllNotFound | Please make sure that in the Topology Builder this server is configured to: Use all configured IP addresses. |
| IA4 | en-US | IDLocalCertStoreNotFound | Please verify if your account has permissions to execute 'Test-Path -Path "Cert:\LocalMachine\Root"' cmdlet. |
| IA5 | en-US | IDLogSpaceThreshold | Please trim the SQL transaction logs. |
| IA6 | en-US | IDMultiHomePossible | Dual or multi-homed configurations are not supported for Front End Servers, Back End Servers, and Standard Edition servers. Please refer to the following article https://docs.microsoft.com/skypeforbusiness/plan/system-requirements. |
| IA7 | en-US | IDNoLogSpace | Please execute 'DBCC SQLPERF(logspace)' t-SQL command against database and confirm 'Log Space Used (%)' is less than 60%. |
| IA8 | en-US | IDNoPoolIPAddresses | Please verify if Frontend End Pool DNS records are configured. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/plan-your-deployment/network-requirements/dns |
| IA9 | en-US | IDPatchUpdateAvailable | Please update to {0} which can be found at {1}. |
| IA10 | en-US | IDTestCsDatabaseNoResults | The 'Test-CsDatabase -LocalService' returned an empty result. If problem persists please contact your system administrator or open a support ticket with Microsoft. |
| IA11 | en-US | IDUnableToGetProductName | Please verify if Get-CsServerVersion cmdlet returns a valid output. |
| IA12 | en-US | IDUnableToGetServiceInfo | Please confirm that 'Get-CsComputer' and 'Get-CsService' cmdlet execution is successful. |
| IA13 | en-US | IDUnableToGetVersion | Please verify if Get-CsServerVersion cmdlet returns a valid output. |
| IA14 | en-US | IDUnableToResolveDNSName | Please confirm that 'Resolve-DnsName' cmdlet successfully performs a DNS query for each Edge Server in the Edge pool and each Frontend in the Frontend pool. |
| IA15 | en-US | IDUnableToResolveServerFQDN | Please execute 'Resolve-DnsName -Name $env:COMPUTERNAME -Type A' cmdlet and confirm valid output is returned. |


