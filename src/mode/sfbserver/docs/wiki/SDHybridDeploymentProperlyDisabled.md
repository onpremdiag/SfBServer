# Validates that the Skype for Business hybrid deployment is disabled
**Owner:** [Owner of this document]

# Description

**[TODO]**

[[_TOC_]]

# Execution flow

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDHybridDeploymentProperlyDisabled
%% Date Generated: 8/18/2021 11:51:04 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDPromptforTeamsCreds[\PDPromptforTeamsCreds\] -.-> SDHybridDeploymentProperlyDisabled

	SDHybridDeploymentProperlyDisabled(SDHybridDeploymentProperlyDisabled) --1--> ADCheckHybridDeployment[ADCheckHybridDeployment]

	ADCheckHybridDeployment -- 1.1 --> RDCheckLyncdiscoverRecord[RDCheckLyncdiscoverRecord]
	ADCheckHybridDeployment -- 1.2 --> RDCheckSharedAddressSpaceNotEnabled[RDCheckSharedAddressSpaceNotEnabled]
	ADCheckHybridDeployment -- 1.3 --> RDCheckSipFedSRVRecords[RDCheckSipFedSRVRecords]
	ADCheckHybridDeployment -- 1.4 --> RDCheckSipRecord[RDCheckSipRecord]
	ADCheckHybridDeployment -- 1.5 --> RDCheckSipTLSSRVRecords[RDCheckSipTLSSRVRecords]
	ADCheckHybridDeployment -- 1.6 --> RDNoOnPremiseUsers[RDNoOnPremiseUsers]
:::

# Rule specifications
### R1 - RDCheckLyncdiscoverRecord
- Determine if lyncdiscover.<domain> DNS CNAME record points to webdir.online.lync.com
``` powershell
    try
    {
        $Domains = Get-CsOnlineSipDomain

        if ([string]::IsNullOrEmpty($Domains))
        {
            throw 'IDGetCsOnlineSipDomainFails'
        }
        else
        {
            foreach($OnlineSipDomainBase in ($Domains | Where-Object {$_.Name -notlike '*onmicrosoft.com'}))
            {
                # Let's look for CNAME lyncdiscover -> webdir.online.lync.com
                $DNSSrvSipFed  = "$($global:LyncDiscover)." + $OnlineSipDomainBase.Name.ToString()
                $resolution    = $null

                $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                -Type CNAME `
                                                -Server $global:DNSServer `
                                                -ErrorAction Stop `
                                                -DnsOnly | Where-Object {$_.Section -eq 'Answer'}

                if ([string]::IsNullOrEmpty($resolution))
                {
                    $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                    -Type ALL `
                                                    -Server $global:DNSServer `
                                                    -ErrorAction Stop `
                                                    -DnsOnly | Where-Object {$_.Section -eq 'Answer'}
                }

                foreach($domain in $resolution)
                {
                    switch($domain.Type)
                    {
                        'CNAME'
                        {
                            if ($domain.NameHost.ToString() -ne $global:WebDir)
                            {
                                throw 'IDDNSOnPremises'
                            }
                        }

                        'A' { throw 'IDDNSARecord' }

                        'SRV' { throw 'IDDNSSRVRecord' }

                        'TXT' { throw 'IDDNSTXTRecord'}

                        default
                        {
                            if (($null -ne $domain.Type) -and `
                                ( `
                                    ($domain.Type -ne 'TXT') -and `
                                    ($domain.Type -ne 'A') -and `
                                    ($domain.Type -ne 'CNAME') -and `
                                    ($domain.Type -ne 'SRV') `
                                )
                                )
                            {
                                throw 'IDDNSTypeOther'
                            }
                        } #default
                    } #switch
                } #foreach
            } #foreach
        } #if domains
    }
```

### R2 - RDCheckOnlineSharedSipAddressSpace
- Determine if the online settings have disabled share SIP address space
``` powershell
    try
    {
        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

        $OL_TenantFedConf = Get-CsTenantFederationConfiguration

        if (-not [string]::IsNullOrEmpty($OL_TenantFedConf))
        {
            $this.Success = -not $OL_TenantFedConf.SharedSipAddressSpace
        }
        else
        {
            $this.Success = $false
        }
    }
```

### R3 - RDCheckSipFedSRVRecords
- Determine if _sipfederationtls._tcp.<sipdomain> DNS SRV record points to sipfed.online.lync.com
``` powershell
    try
    {
        $Domains = Get-CsOnlineSipDomain

        if ([string]::IsNullOrEmpty($Domains))
        {
            throw 'IDGetCsOnlineSipDomainFails'
        }
        else
        {
            foreach($OnlineSipDomainBase in ($Domains | Where-Object {$_.Name -notlike '*onmicrosoft.com'}))
            {
                # Let's look for SRV SIPTLS
                $DNSSrvSipFed  = "$($global:SIPFederationTLS)." + $OnlineSipDomainBase.Name.ToString()
                $resolution    = $null

                $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                -Type SRV `
                                                -Server $global:DNSServer `
                                                -ErrorAction Stop `
                                                -DnsOnly | Where-Object {$_.Section -eq 'Answer'}

                if ([string]::IsNullOrEmpty($resolution))
                {
                    $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                    -Type ALL `
                                                    -Server $global:DNSServer `
                                                    -ErrorAction Stop `
                                                    -DnsOnly | Where-Object {$_.Section -eq 'Answer'}
                }

                foreach($domain in $resolution)
                {
                    switch($domain.Type)
                    {
                        'SRV'
                        {
                            if ($domain.NameTarget.ToString() -ne $global:SIPFederationTLS)
                            {
                                throw 'IDDNSOnPremises'
                            }
                        }

                        'A' { throw 'IDDNSARecord' }

                        'CNAME' { throw 'IDDNSCNAMERecord' }

                        'TXT' { throw 'IDDNSTXTRecord'}

                        default
                        {
                            if (($null -ne $domain.Type) -and `
                                ( `
                                    ($domain.Type -ne 'TXT') -and `
                                    ($domain.Type -ne 'A') -and `
                                    ($domain.Type -ne 'CNAME') -and `
                                    ($domain.Type -ne 'SRV') `
                                )
                                )
                            {
                                throw 'IDDNSTypeOther'
                            }
                        } #default
                    } #switch
                } #foreach
            } #foreach
        } #if domains
    } #try
```

### R4 - RDCheckSipRecord
- Determine if sip.<domain> DNS CNAME record points to sipdir.online.lync.com
``` powershell
    try
    {
        $Domains = Get-CsOnlineSipDomain

        if ([string]::IsNullOrEmpty($Domains))
        {
            throw 'IDGetCsOnlineSipDomainFails'
        }
        else
        {
            foreach($OnlineSipDomainBase in ($Domains | Where-Object {$_.Name -notlike '*onmicrosoft.com'}))
            {
                # Let's look for CNAME sip -> sipdir.online.lync.com
                $DNSSrvSipFed  = "sip." + $OnlineSipDomainBase.Name.ToString()
                $resolution    = $null

                $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                -Type CNAME `
                                                -Server $global:DNSServer `
                                                -ErrorAction Stop `
                                                -DnsOnly | Where-Object {$_.Section -eq 'Answer'}

                if ([string]::IsNullOrEmpty($resolution))
                {
                    $resolution = Resolve-DnsName -Name $DNSSrvSipFed `
                                                    -Type ALL `
                                                    -Server $global:DNSServer `
                                                    -ErrorAction Stop `
                                                    -DnsOnly | Where-Object {$_.Section -eq 'Answer'}
                }

                foreach($domain in $resolution)
                {
                    switch($domain.Type)
                    {
                        'CNAME'
                        {
                            if ($domain.NameHost.ToString() -ne $global:SIPDir)
                            {
                                throw 'IDDNSOnPremises'
                            }
                        }

                        'A' { throw 'IDDNSARecord' }

                        'SRV' { throw 'IDDNSSRVRecord' }

                        'TXT' { throw 'IDDNSTXTRecord'}

                        default
                        {
                            if (($null -ne $domain.Type) -and `
                                ( `
                                    ($domain.Type -ne 'TXT') -and `
                                    ($domain.Type -ne 'A') -and `
                                    ($domain.Type -ne 'CNAME') -and `
                                    ($domain.Type -ne 'SRV') `
                                )
                                )
                            {
                                throw 'IDDNSTypeOther'
                            }
                        } #default
                    } #switch
                } #foreach
            } #foreach
        } #if domains
    } #try
```

### R5 - RDCheckSipTLSSRVRecords
- Determine if _sip.tls.<sipdomain> DNS SRV record points to sipdir.online.lync.com
``` powershell
    try
    {
        $Domains = Get-CsOnlineSipDomain

        if ([string]::IsNullOrEmpty($Domains))
        {
            throw 'IDGetCsOnlineSipDomainFails'
        }
        else
        {
            foreach($OnlineSipDomainBase in ($Domains | Where-Object {$_.Name -notlike '*onmicrosoft.com'}))
            {
                # Let's look for SRV SIPTLS
                $DNSSrvSip  = "$($global:SIPTLS)." + $OnlineSipDomainBase.Name.ToString()
                $resolution = $null

                $resolution = Resolve-DnsName -Name $DNSSrvSip `
                                                -Type SRV `
                                                -Server $global:DNSServer `
                                                -ErrorAction Stop `
                                                -DnsOnly | Where-Object {$_.Section -eq 'Answer'}

                #if ($resolution.Count -lt 1)
                if ([string]::IsNullOrEmpty($resolution))
                {
                    $resolution = Resolve-DnsName -Name $DNSSrvSip `
                                                    -Type ALL `
                                                    -Server $global:DNSServer `
                                                    -ErrorAction Stop `
                                                    -DnsOnly | Where-Object {$_.Section -eq 'Answer'}
                }

                foreach($domain in $resolution)
                {
                    switch($domain.Type)
                    {
                        'SRV'
                        {
                            if ($domain.NameTarget.ToString() -ne $global:SIPDir)
                            {
                                throw 'IDDNSOnPremises'
                            }
                        }

                        'A' { throw 'IDDNSARecord' }

                        'CNAME' { throw 'IDDNSCNAMERecord' }

                        'TXT' { throw 'IDDNSTXTRecord'}

                        default
                        {
                            if (($null -ne $domain.Type) -and `
                                ( `
                                    ($domain.Type -ne 'TXT') -and `
                                    ($domain.Type -ne 'A') -and `
                                    ($domain.Type -ne 'CNAME') -and `
                                    ($domain.Type -ne 'SRV') `
                                )
                                )
                            {
                                throw 'IDDNSTypeOther'
                            }
                        } #default
                    } #switch
                } #foreach
            } #foreach
        } #if domains
    } #try
```

### R6 - RDNoOnPremiseUsers
- Determine if there are any On-Premise users still present
``` powershell
    try
    {
        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

        $Users = Get-CsOnlineUser

        $OnlineUsers = $Users | Where-Object {$_.Enabled -and -not [string]::IsNullOrEmpty($_.OnPremHostingProvider)} | `
            Select-object -Property SipAddress, InterpretedUserType, OnPremHostingProvider

        if (-not [string]::IsNullOrEmpty($OnlineUsers) -or $OnlineUsers -is [array])
        {
            throw 'IDOnPremiseUsersFound'
        }
        else
        {
            $OnlineUsers = $Users | Where-Object {$_.Enabled -and `
                    -not [string]::IsNullOrEmpty($_.MCOValidationError) -or `
                    -not [string]::IsNullOrEmpty($_.ProvisioningStamp) -or `
                    -not [string]::IsNullOrEmpty($_.SubProvisioningStamp)
            } | Select-object -Property SipAddress, InterpretedUserType, OnPremHostingProvider, MCOValidationError, *ProvisioningStamp

            if (-not [string]::IsNullOrEmpty($OnlineUsers) -or $OnlineUsers -is [array])
            {
                throw 'IDUsersValidationErrorFound'
            }
        }
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDHybridDeploymentProperlyDisabled | Validates that the Skype for Business hybrid deployment is disabled


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDPromptforTeamsCreds |  | Next you will be prompted for Teams Administrator/Global Administrator credentials. Please press Enter to continue |  |


### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADCheckHybridDeployment | Verifies if Skype for Business Hybrid deployment was properly disabled|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckLyncdiscoverRecord | Determine if lyncdiscover.<domain> DNS CNAME record points to webdir.online.lync.com |
| R2 | en-US | RDCheckSharedAddressSpaceNotEnabled | Determine if the SkypeforBusinessOnline hosting provider SharedAddressSpace is disabled |
| R3 | en-US | RDCheckSipFedSRVRecords | Determine if _sipfederationtls._tcp.<sipdomain> DNS SRV record points to sipfed.online.lync.com |
| R4 | en-US | RDCheckSipRecord | Determine if sip.<domain> DNS CNAME record points to sipdir.online.lync.com |
| R5 | en-US | RDCheckSipTLSSRVRecords | Determine if _sip.tls.<sipdomain> DNS SRV record points to sipdir.online.lync.com |
| R6 | en-US | RDNoOnPremiseUsers | Determine if there are any On-Premise users still present |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDDNSARecord | The DNS record for '{0}' is pointing to an A record - unable to determine results |
| ID2 | en-US | IDDNSCNAMERecord | The DNS record for '{0} is pointing to a CNAME record |
| ID4 | en-US | IDDNSOnPremises | The DNS SRV record for '{0}' does not point to online environment, '{1}' |
| ID5 | en-US | IDDNSSRVRecord | The DNS SRV record for '{0}' is pointing to an online environment, '{1}' |
| ID6 | en-US | IDDNSTXTRecord | The DNS record for '{0} is pointing to a TXT record |
| ID7 | en-US | IDDNSTypeOther | The DNS record for '{0} is pointing to an unexpected type: {1} record |
| ID8 | en-US | IDGetCsOnlineSipDomainFails | Call to Get-CsOnlineSipDomain has failed |
| ID9 | en-US | IDOnPremiseUsersFound | Skype for Business On-Premises users have been found |
| ID10 | en-US | IDUsersValidationErrorFound | Microsoft 365 users with validation errors have been found |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDDNSARecord | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA2 | en-US | IDDNSCNAMERecord | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA4 | en-US | IDDNSOnPremises | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA5 | en-US | IDDNSSRVRecord | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA6 | en-US | IDDNSTXTRecord | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA7 | en-US | IDDNSTypeOther | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-disabling-hybrid for guidance |
| IA8 | en-US | IDGetCsOnlineSipDomainFails | Please contact your system administrator or open a support ticket with Microsoft. |
| IA9 | en-US | IDOnPremiseUsersFound | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-managing-attributes#method-2---clear-skype-for-business-attributes-for-all-on-premises-users-in-active-directory |
| IA10 | en-US | IDUsersValidationErrorFound | Please refer to https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-managing-attributes#method-2---clear-skype-for-business-attributes-for-all-on-premises-users-in-active-directory |



