# Check if response group usage report runs correctly
**Owner:** João Loureiro

# Description
This scenario checks to see if the Response Usage Report returns a result within
60 seconds, or less. If it doesn't, that is usually an indication that the indicies
need to re-built.

[[_TOC_]]

# Execution flow

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDResponseGroupUsageReport
%% Date Generated: 11/30/2021 12:40:18 PM
%% This file is autogenerated. Please do not edit directly
%%


	SDResponseGroupUsageReport(SDResponseGroupUsageReport) --1--> ADRGSUsageTrend[ADRGSUsageTrend]

	ADRGSUsageTrend -- 1.1 --> RDUsageTrend[RDUsageTrend]

:::


# Rule specifications
### R1 - RDUsageTrend
- Determine if the Usage Report returns results in the expected time limit (60 sec)
````Powershell
    $StartTime    = (Get-Date).AddMonths(-1)
    $EndTime      = (Get-Date)
    $WorkFlowUri  = [string]::Empty
    $Size         = '1440'

    $ArgumentList = "StartTime = '$($StartTime)'", "EndTime = '$($EndTime)'",
                    "WorkFlowUri = '$($WorkFlowUri)'", "Size = '$($Size)'"

    $MonitoringDatabase = Get-CsService -MonitoringDatabase | Select-Object -Property PoolFqdn, SqlInstanceName
    $SQLDatabase        = $MonitoringDatabase.PoolFqdn

    if (-not [string]::IsNullOrEmpty($MonitoringDatabase.SqlInstanceName))
    {
        $SQLDatabase = "{0}\{1}" -f $MonitoringDatabase.PoolFqdn, $MonitoringDatabase.SqlInstanceName
    }

    # If we return in <= 60 seconds, it's considered a pass, regardless of results returned
    $SQLArguments = @{
        ServerInstance = $SQLDatabase
        Database       = 'LcsCDR'
        QueryTimeout   = 60
        ConnectionTime = 60
        Query          = "EXEC [dbo].[CdrRGSUsageTrend] @_StartTime = `$(StartTime),
                            @_EndTime = `$(EndTime), @_WorkflowUri = `$(WorkFlowUri),
                            @_Interval = `$(Size), @_WindowSize = `$(Size)"
        Variable       = $ArgumentList
    }

    $TimeToRun = Measure-Command { Invoke-Sqlcmd @SQLArguments }

    # Did we timeout?
    if ($TimeToRun.Seconds -gt 60)
    {
        throw 'IDRGSUsageTrend'
    }
````



# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDResponseGroupUsageReport | Check if response group usage report runs correctly




### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADRGSUsageTrend | Verifies that the Response Group Usage Report is working properly|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDUsageTrend | Determine if the Usage Report returns results in the expected time limit (60 sec) |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDRGSUsageTrend | Report Group Usage Report has timed out |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDRGSUsageTrend | Please refer to the following guidance: https://social.technet.microsoft.com/Forums/office/en-US/7e472c38-35ac-42cb-ad4a-a683eb0becac/response-group-usage-report-not-working?forum=lyncinterop |



