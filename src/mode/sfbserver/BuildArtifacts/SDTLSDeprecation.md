# Check to see if TLS 1.0/1.1 deprecation is properly configured
**Owner:** [Owner of this document]

# Description

**[TODO]**

[[_TOC_]]

# Execution flow

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDTLSDeprecation
%% Date Generated: 11/30/2021 12:40:19 PM
%% This file is autogenerated. Please do not edit directly
%%


	SDTLSDeprecation(SDTLSDeprecation) --1--> ADCheckSSLSettings[ADCheckSSLSettings]

	ADCheckSSLSettings -- 1.1 --> RDCheckSSLSettings[RDCheckSSLSettings]
	SDTLSDeprecation --2 --> ADCheckTLSSettings[ADCheckTLSSettings]

	ADCheckTLSSettings -- 2.1 --> RDCheckTLSSettings[RDCheckTLSSettings]
	SDTLSDeprecation --3 --> ADCheckWinHttp[ADCheckWinHttp]

	ADCheckWinHttp -- 3.1 --> RDCheckWinHttpSettings[RDCheckWinHttpSettings]

:::


# Rule specifications
### R1 - RDCheckSSLSettings
- Determine if the SSL 3.0/2.0 settings have been properly configured for TLS 1.0/1.1 deprecation
````Powershell
    {
        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

        # Product Backlog Item 33706: Diagnostic Investment - Validate Skype for Business Server TLS 1.0 / 1.1 deprecation
        # Diagnostic should only check local FE plus SQL associated with current FE pool

        # Current local FE
        $FEServer = $null
        $Pools    = Get-CSPool -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($Pools))
        {
                $FEServer = $Pools | Where-Object {$_.Services -like '*Registrar*'} | Where-Object {$_.Fqdn -eq $env:COMPUTERNAME+'.'+$env:USERDNSDOMAIN}
        }

        if (-not [string]::IsNullOrEmpty($FEServer))
        {
            $localFE     = $FEServer.Fqdn
            $SSLSettings = Get-AllTlsSettingsFromRegistry -MachineName $localFE
            $finished    = $false

            if (-not [string]::IsNullOrEmpty($SSLSettings))
            {
                $step = 1
                while(-not $finished)
                {
                    switch($step)
                    {
                        1 # SSL 3.0 should be disabled by default (true) and not enabled (false)
                        {
                            $ssl30 = $SSLSettings.ssl | Where-Object {$_.SSLVersion -eq '3.0'}

                            if (-not [string]::IsNullOrEmpty($ssl30))
                            {
                                if ($ssl30.ServerDisabledByDefault -and -not $ssl30.ServerEnabled)
                                {
                                    break
                                }
                                else
                                {
                                    throw 'IDSSL30NotDisabled'
                                }
                            }
                        }

                        2 # SSL 2.0 should be disabled by default (true) and not enabled (false)
                        {
                            $ssl20 = $SSLSettings.SSL | Where-Object {$_.SSLVersion -eq '2.0'}

                            if (-not [string]::IsNullOrEmpty($ssl20))
                            {
                                if ($ssl20.ServerDisabledByDefault -and -not $ssl20.ServerEnabled)
                                {
                                    break
                                }
                                else
                                {
                                    throw 'IDSSL20NotDisabled'
                                }
                            }
                        }

                        default
                        {
                            $finished = $true
                        }
                    }

                    $step++
                }
            }
        }
        else
        {
            throw 'IDNotFEMachine'
        }
    }
````

### R2 - RDCheckTLSSettings
- Determine if the TLS 1.2, or better, has been properly enabled
````Powershell
    Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

    # Product Backlog Item 33706: Diagnostic Investment - Validate Skype for Business Server TLS 1.0 / 1.1 deprecation
    # Diagnostic should only check local FE plus SQL associated with current FE pool

    # Current local FE
    $FEServer = $null
    $Pools    = Get-CSPool -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($Pools))
    {
            $FEServer = $Pools | Where-Object {$_.Services -like '*Registrar*'} | Where-Object {$_.Fqdn -eq $env:COMPUTERNAME+'.'+$env:USERDNSDOMAIN}
    }

    if (-not [string]::IsNullOrEmpty($FEServer))
    {
        $localFE     = $FEServer.Fqdn
        $tlsSettings = Get-AllTlsSettingsFromRegistry -MachineName $localFE
        $finished    = $false

        if (-not [string]::IsNullOrEmpty($tlsSettings))
        {
            $step = 1
            while(-not $finished)
            {
                switch($step)
                {
                    1 # TLS 1.2 Server should be enabled
                    {
                        $tls12 = $tlsSettings.tls | Where-Object {$_.TLSVersion -eq '1.2'}

                        if (-not [string]::IsNullOrEmpty($tls12))
                        {
                            if (-not $tls12.ServerDisabledByDefault -and $tls12.ServerEnabled)
                            {
                                break
                            }
                            else
                            {
                                throw 'IDTLS12NotEnabled'
                            }
                        }
                        else
                        {
                            throw 'IDTLS12NotEnabled'
                        }
                    }

                    2 # TLS 1.1 should be disabled
                    {
                        $tls11 = $tlsSettings.tls | Where-Object {$_.TLSVersion -eq '1.1'}

                        if (-not [string]::IsNullOrEmpty($tls11))
                        {
                            if ($tls11.ServerDisabledByDefault -and -not $tls11.ServerEnabled)
                            {
                                break
                            }
                            else
                            {
                                throw 'IDTLS11NotDisabled'
                            }
                        }
                        else
                        {
                            throw 'IDTLS11NotDisabled'
                        }
                    }

                    3 # TLS 1.0 should be disabled
                    {
                        $tls10 = $tlsSettings.tls | Where-Object {$_.TLSVersion -eq '1.0'}

                        if (-not [string]::IsNullOrEmpty($tls10))
                        {
                            if ($tls10.ServerDisabledByDefault -and -not $tls10.ServerEnabled)
                            {
                                break
                            }
                            else
                            {
                                throw 'IDTLS10NotDisabled'
                            }
                        }
                        else
                        {
                            throw 'IDTLS10NotDisabled'
                        }
                    }

                    default
                    {
                        $finished = $true
                    }
                }

                $step++
            }
        }
        else
        {
            throw
        }
    }
    else
    {
        throw 'IDNotFEMachine'
    }
````

### R3 - RDCheckWinHttpSettings
- Determine if the WinHTTP settings have been properly configured for TLS 1.0/1.1 deprecation
````Powershell
    Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

    # Product Backlog Item 33706: Diagnostic Investment - Validate Skype for Business Server TLS 1.0 / 1.1 deprecation
    # Diagnostic should only check local FE plus SQL associated with current FE pool

    # Current local FE
    $FEServer = $null
    $Pools    = Get-CSPool -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($Pools))
    {
            $FEServer = $Pools | Where-Object {$_.Services -like '*Registrar*'} | Where-Object {$_.Fqdn -eq $env:COMPUTERNAME+'.'+$env:USERDNSDOMAIN}
    }

    if (-not [string]::IsNullOrEmpty($FEServer))
    {
        $localFE     = $FEServer.Fqdn
        $WinHTTPSettingsx32 = Invoke-RegistryGetValue -MachineName $localFE `
                                -SubKey 'SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp' `
                                -GetValue 'DefaultSecureProtocols' -DefaultValue $null
        $WinHTTPSettingsx64 = Invoke-RegistryGetValue -MachineName $localFE `
                                -SubKey 'SOFTWARE\Wow6432\Microsoft\Windows\CurrentVersion\Internet Settings\WinHttp' `
                                -GetValue 'DefaultSecureProtocols' -DefaultValue $null

        $finished    = $false

        if (-not [string]::IsNullOrEmpty($WinHTTPSettingsx32) -or -not [string]::IsNullOrEmpty($WinHTTPSettingsx64))
        {
            $step = 1
            while(-not $finished)
            {
                switch($step)
                {
                    1 # Check x32 settings for "DefaultSecureProtocols"=dword:00000AA0
                    {
                        if (-not [string]::IsNullOrEmpty($WinHTTPSettingsx32))
                        {
                            if ($WinHTTPSettingsx32 -eq 0x0AA0)
                            {
                                break
                            }
                            else
                            {
                                throw 'IDWinHTTPSettingsx32'
                            }
                        }
                        else
                        {
                            throw 'IDWinHTTPSettingsx32'
                        }
                    }

                    2 # Check x64 settings for "DefaultSecureProtocols"=dword:00000AA0
                    {
                        if (-not [string]::IsNullOrEmpty($WinHTTPSettingsx64))
                        {
                            if ($WinHTTPSettingsx64 -eq 0x0AA0)
                            {
                                break
                            }
                            else
                            {
                                throw 'IDWinHTTPSettingsx64'
                            }
                        }
                        else
                        {
                            throw 'IDWinHTTPSettingsx64'
                        }
                    }

                    default
                    {
                        $finished = $true
                    }
                }

                $step++
            }
        }
        else
        {
            throw
        }
    }
    else
    {
        throw 'IDNotFEMachine'
    }
````

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDTLSDeprecation | Check to see if TLS 1.0/1.1 deprecation is properly configured




### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADCheckSSLSettings | Verifies SSL 3.0/2.0 are properly configured for TLS 1.1/1.0 deprecation|
| A2 | en-US | ADCheckTLSSettings | Verifies TLS 1.0/1.1 deprecation|
| A3 | en-US | ADCheckWinHttp | Verifies WinHTTP protocol settings for TLS 1.2 compliance|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckSSLSettings | Determine if the SSL 3.0/2.0 settings have been properly configured for TLS 1.0/1.1 deprecation |
| R2 | en-US | RDCheckTLSSettings | Determine if the TLS 1.2, or better, has been properly enabled |
| R3 | en-US | RDCheckWinHttpSettings | Determine if the WinHTTP settings have been properly configured for TLS 1.0/1.1 deprecation |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDNotFEMachine | Current machine is not a FrontEnd server. |
| ID2 | en-US | IDTLSNotEnabled | {0} not configured correctly. DisabledByDefault: Expected: 0, Actual: {1}, Enabled: Expected: 1, Actual: {2} |
| ID3 | en-US | IDWinHttpSecureProtocols | WinHTTP 'DefaultSecureProtocol' has incorrect value. Expected: 2720 (0xAA0), Actual: {0} ({1}) |
| ID4 | en-US | IDSSLNotDisabled | {0} not configured correctly. DisabledByDefault: Expected: 1, Actual: {1}, Enabled: Expected: 0, Actual: {2} |

### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDNotFEMachine | Please ensure that you are on a FrontEnd server and run the test again. |
| IA2 | en-US | IDTLSNotEnabled | Please refer to the following guidance: https://techcommunity.microsoft.com/t5/skype-for-business-blog/preparing-for-tls-1-0-1-1-deprecation-o365-skype-for-business/ba-p/222247 |
| IA3 | en-US | IDWinHttpSecureProtocols | Please refer to the following guidance: https://techcommunity.microsoft.com/t5/skype-for-business-blog/preparing-for-tls-1-0-1-1-deprecation-o365-skype-for-business/ba-p/222247 |
| IA4 | en-US | IDSSLNotDisabled | Please refer to the following guidance: https://techcommunity.microsoft.com/t5/skype-for-business-blog/preparing-for-tls-1-0-1-1-deprecation-o365-skype-for-business/ba-p/222247 |


