# Checks the integration between Skype for Business Server and Exchange Online deployment
**Owner:** [Owner of this document]

# Description

**[TODO]**

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDExchangeOnlineIntegrationNotWorking
%% Date Generated: 6/23/2021 10:06:56 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDSipAddress[\PDSipAddress\] -.-> SDExchangeOnlineIntegrationNotWorking
	PDPromptForAADCreds[\PDPromptForAADCreds\] -.-> SDExchangeOnlineIntegrationNotWorking

	SDExchangeOnlineIntegrationNotWorking(SDExchangeOnlineIntegrationNotWorking) --1--> ADExchangeOnline[ADExchangeOnline]

	ADExchangeOnline -- 1.1 --> RDTestAppPrincipalExists[RDTestAppPrincipalExists]
	ADExchangeOnline -- 1.2 --> RDTestAutoDiscover[RDTestAutoDiscover]
	ADExchangeOnline -- 1.3 --> RDOAuthCertificateValid[RDOAuthCertificateValid]
	ADExchangeOnline -- 1.4 --> RDTestOAuthServerConfiguration[RDTestOAuthServerConfiguration]
	ADExchangeOnline -- 1.5 --> RDTestPartnerApplication[RDTestPartnerApplication]
	ADExchangeOnline -- 1.6 --> RDTestExchangeConnectivity[RDTestExchangeConnectivity]

:::


# Rule specifications
### R1 - RDOAuthCertificateValid
- Determine if the OAuthTokenIssuer certificate has not expired and has a serial number<br/>
``` powershell
    $OAuthTokenIssuer = Get-CsCertificate -Type OAuthTokenIssuer -ErrorAction SilentlyContinue

    if (-not [string]::IsNullOrEmpty($OAuthTokenIssuer))
    {
        if ($OAuthTokenIssuer.NotAfter -ge (Get-Date))
        {
            if ([string]::IsNullOrEmpty($OAuthTokenIssuer.Thumbprint))
            {
                throw 'IDOAuthCertficateNoThumbprint'
            }
        }
        else
        {
            throw 'IDOAuthCertficateExpired'
        }
    }
    else
    {
        throw 'IDMissingOAuthCertificate'
    }
```

### R2 - RDTestAppPrincipalExists
- Determine if the app principal ID exists<br/>
``` powershell
    $ServiceName = "00000004-0000-0ff1-ce00-000000000000"

    # 1. Establish connection with Azure Active Directory (AAD)
    Connect-MsolService -AzureEnvironment $global:OPDOptions.AzureEnvironment -ErrorAction SilentlyContinue

    if ($?)
    {
        # Do the rest
        # 2. Does the service name exist?
        $AppPrincipalSFB = Get-MsolServicePrincipalCredential -ReturnKeyValues $true `
                                -ServicePrincipalName $ServiceName `
                                -ErrorAction SilentlyContinue

        if (-not [string]::IsNullOrEmpty($AppPrincipalSFB))
        {
            # 3. List all SPN's configured for O365
            $listSPNs = Get-MsolServicePrincipal -ServicePrincipalName $ServiceName |
                            Select-Object -ExpandProperty ServicePrincipalNames

            if (-not [string]::IsNullOrEmpty($listSPNs))
            {
                # 4. Get the list of all the Skype for Business Server External WebServices
                $listExternalFQDNs = Get-CsService | Select-Object externalfqdn -Unique |
                                        Where-Object {$_.externalfqdn -ne $null}

                $success = $false

                foreach ($listSPN in $listSPNs)
                {
                    if ($listSPN -like "*$($listExternalFQDNs.ExternalFqdn)*")
                    {
                        $success = $success -bor $true
                        break
                    }
                    else
                    {
                        $success = $success -bor $false
                    }
                }

                if (-not $success)
                {
                    throw 'IDExternalWSNotInSPNList'
                }
            }
            else
            {
                throw 'IDNoServicePrincipalNames'
            }
        }
        else
        {
            throw 'IDServicePrincipalDoesNotExist'
        }
    }
    else
    {
        throw 'IDUnableToConnectToAAD'
    }
```

### R3 - RDTestAutoDiscover
- Determine if the DNS name for the Autodiscover is resolvable<br/>
``` powershell
    $domainName               = $env:USERDNSDOMAIN
    $expectedAutoDiscoverName = "autodiscover.$domainName"
    $actualServerName         = $expectedAutoDiscoverName

    if (-not [string]::IsNullOrEmpty($domainName))
    {

        $autoDiscoverCNAMERecord = Resolve-DnsName -Name $expectedAutoDiscoverName -Server 8.8.8.8 -Type CNAME -ErrorAction SilentlyContinue
        $autoDiscoverARecord     = Resolve-DnsName -Name $actualServerName -Server 8.8.8.8 -Type A -ErrorAction SilentlyContinue |
                                    Where-Object {$_.Type -eq 'A'}

        if (-not [string]::IsNullOrEmpty($autoDiscoverCNAMERecord))
        {
            $actualServerName = $autoDiscoverCNAMERecord.NameHost

            if (-not $actualServerName.EndsWith($domainName,'CurrentCultureIgnoreCase'))
            {
                # CNAME record does not respect strict name matching
                throw 'IDAutoDiscoverNameDoNotMatch'
            }
        }
        elseif ([string]::IsNullOrEmpty($autoDiscoverARecord))
        {
            # Possible missing DNS record
            throw 'IDDNSNameDoesNotExist'
        }
    }
    else
    {
        # unable to determine domain name from the environment variable
        throw 'IDUnknownDomain'
    }
```

### R4 - RDTestExchangeConnectivity
- Determine if the Skype for Business Server Storage Service is working on a Front End Server<br/>
``` powershell
    $currentSipAddress = Get-ParameterDefinition -Object $this -ParameterName 'PDSipAddress'

    if (-not [string]::IsNullOrEmpty($currentSipAddress))
    {
        $connectivity = Test-CsExStorageConnectivity -SipUri $currentSipAddress -ErrorAction SilentlyContinue

        if ($connectivity -notlike '*passed*')
        {
            # Test failed
            throw 'IDNoExchangeConnectivity'
        }
    }
    else
    {
        # no sip address found - we shouldn't hit this
        throw 'IDNoSIPAddress'
    }
```

### R5 - RDTestOAuthServerConfiguration
- Determine if the OAuthServer configuration is correct<br/>
``` powershell
    $expectedValue              = "https://accounts.accesscontrol.windows.net/{0}/metadata/json/1"

    try
    {
        $OAuthServerConfiguration = Get-CsOAuthServer -Identity 'microsoft.sts'

        if (-not [string]::IsNullOrEmpty($OAuthServerConfiguration))
        {
            $TenantID = $OAuthServerConfiguration.Realm

            if (-not [string]::IsNullOrEmpty($TenantID))
            {
                $expectedValue = $expectedValue -f $TenantID

                if ($OAuthServerConfiguration.MetadataUrl -ne $expectedValue)
                {
                    throw 'IDWrongOnlineMetadataUrlConfiguration'
                }
            }
            else
            {
                throw 'IDNoTenantIDFound'
            }
        }
        else
        {
            # No oAuth config information returned
            throw 'IDNoOAuthServer'
        }
    }
```

### R6 - RDTestPartnerApplication
- Determine if the Exchange application service exists and has the correct values<br/>
``` powershell
    $ServiceName = "00000002-0000-0ff1-ce00-000000000000"

    $PartnerApplication = Get-CsPartnerApplication -Identity "Microsoft.Exchange"

    if (-not [string]::IsNullOrEmpty($PartnerApplication))
    {
        if ($PartnerApplication.Enabled)
        {
            if ($PartnerApplication.ApplicationIdentifier -ne $ServiceName)
            {
                throw 'IDWrongPartnerApplication'
            }
        }
        else
        {
            throw 'IDPartnerApplicationDisabled'
        }
    }
    else
    {
        throw 'IDNoPartnerApplication'
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
- ***[TODO]***

(...)


### Scenario Description<br/>
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-us | SDExchangeOnlineIntegrationNotWorking | Checks the integration between Skype for Business Server and Exchange Online deployment


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDPromptForAADCreds |  | Next you will be prompted for Azure AD admin credentials. Please press Enter to continue |  |
| P2 | en-US | PDSipAddress | The SIP address for the account. Commonly the same as the UPN | User SIP Address | user1@contoso.com | user@domain.contoso.com |

### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADExchangeOnline | Verifies that connectivity with Exchange Online is configured correctly|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDOAuthCertificateValid | Determine if the OAuthTokenIssuer certificate has not expired and has a serial number |
| R2 | en-US | RDTestAppPrincipalExists | Determine if the app principal ID exists |
| R3 | en-US | RDTestAutoDiscover | Determine if the DNS name for the Autodiscover is resolvable |
| R4 | en-US | RDTestExchangeConnectivity | Determine if the Skype for Business Server Storage Service is working on a Front End Server |
| R5 | en-US | RDTestOAuthServerConfiguration | Determine if the OAuthServer configuration is correct |
| R6 | en-US | RDTestPartnerApplication | Determine if the Exchange application service exists and has the correct values |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDAutoDiscoverNameDoNotMatch | Autodiscover DNS CNAME record '{0}' points to a DNS A record. '{1}' is not respecting domain strict name matching |
| ID2 | en-US | IDDNSNameDoesNotExist | The DNS name, '{0}', does not appear to exist |
| ID3 | en-US | IDExternalWSNotInSPNList | External web service does not exist in Service Principal Names (SPN) list |
| ID4 | en-US | IDMissingOAuthCertificate | Unable to locate a OAuthTokenIssuer certificate |
| ID5 | en-US | IDNoExchangeConnectivity | Test-CsExStorageConnectivity cmdlet that verifies if Skype for Business Server Storage service can communicate with Exchange Server failed for SIP user {0} |
| ID6 | en-US | IDNoOAuthServer | No output returned by Get-CsAuthServer cmdlet |
| ID7 | en-US | IDNoPartnerApplication | Unable to locate Exchange partner application information. |
| ID8 | en-US | IDNoServicePrincipalNames | Unable to get service principal name information |
| ID9 | en-US | IDNoSIPAddress | Lookup failed to find '{0}' SIP user. |
| ID10 | en-US | IDNoTenantIDFound | Get-CsOAuthServer cmdlet returned mismatched Metadata URL realm. |
| ID11 | en-US | IDOAuthCertficateExpired | The OAuthTokenIssuer certificate has expired |
| ID12 | en-US | IDOAuthCertficateNoThumbprint | The OAuthTokenIssuer does not have a valid thumbprint |
| ID13 | en-US | IDPartnerApplicationDisabled | Exchange partner application returned by Get-CsPartnerApplication is disable. |
| ID14 | en-US | IDServicePrincipalDoesNotExist | Unable to locate service principal name. |
| ID15 | en-US | IDUnableToConnectToAAD | Unable to establish connection with Azure Active Directory (AAD) |
| ID16 | en-US | IDUnknownDomain | Unable to determine the user DNS domain |
| ID17 | en-US | IDWrongOnlineMetadataUrlConfiguration | Wrong partner application AuthToken Metadata configuration detected. Expected '{0}' but got '{1}' |
| ID18 | en-US | IDWrongPartnerApplication | Microsoft.Exchange partner application is registered for an incorrect service name. |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDAutoDiscoverNameDoNotMatch | Please confirm that '{0}' CNAME record points to a DNS record within same domain complying with strict name matching. For more details, please refer to the following article: https://docs.microsoft.com/exchange/architecture/client-access/autodiscover?view=exchserver-2019. |
| IA2 | en-US | IDDNSNameDoesNotExist | Please verify that the domain name, '{0}', is correct and attempt this operation again. |
| IA3 | en-US | IDExternalWSNotInSPNList | Please verify that Skype for Business Server external Web services URLs are registered as Service Principal names. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA4 | en-US | IDMissingOAuthCertificate | Please open Skype for Business Server Deployment Wizard, select Install or Update Skype for Business Server System and run Step 3 to validate OAuth certificate. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/assign-a-server-to-server-certificate. |
| IA5 | en-US | IDNoExchangeConnectivity | Please refer to the following for guidance: https://blog.schertz.name/2015/09/exchange-and-skype-for-business-integration/ |
| IA6 | en-US | IDNoOAuthServer | Please confirm PowerShell script available at https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment has been properly executed. |
| IA7 | en-US | IDNoPartnerApplication | Please refer to the following guidance: https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA8 | en-US | IDNoServicePrincipalNames | Please verify that Skype for Business Server external Web services URls are registered as Service Principal names. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA9 | en-US | IDNoSIPAddress | Please verify that SIP user {0} is SIP enabled and have an associated mailbox. |
| IA10 | en-US | IDNoTenantIDFound | Please confirm that prior to executing PowerShell script available at https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment you have replaced 'Fabrikam.com' by your tenant default domain |
| IA11 | en-US | IDOAuthCertficateExpired | Please open Skype for Business Server Deployment Wizard, select Install or Update Skype for Business Server System and run Step 3 to validate OAuth certificate. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/assign-a-server-to-server-certificate. |
| IA12 | en-US | IDOAuthCertficateNoThumbprint | Please open Skype for Business Server Deployment Wizard, select Install or Update Skype for Business Server System and run Step 3 to validate OAuth certificate. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/assign-a-server-to-server-certificate. |
| IA13 | en-US | IDPartnerApplicationDisabled | Please consider enabling partner application or just re-run PowerShell script available at https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA14 | en-US | IDServicePrincipalDoesNotExist | Please verify that Skype for Business Server external Web services URLs are registered as Service Principal names. For more details please refer to the following article https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA15 | en-US | IDUnableToConnectToAAD | Please verify you can connect to Azure AD using Connect-MsolService. For more details please refer to the following article https://docs.microsoft.com/microsoft-365/enterprise/connect-to-microsoft-365-powershell?view=o365-worldwide |
| IA16 | en-US | IDUnknownDomain | Please confirm if $env:USERDNSDOMAIN environment variable points to correct user local domain |
| IA17 | en-US | IDWrongOnlineMetadataUrlConfiguration | Please refer to the following guidance: https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |
| IA18 | en-US | IDWrongPartnerApplication | Please re-run PowerShell script available at https://docs.microsoft.com/skypeforbusiness/manage/authentication/configure-a-hybrid-environment |