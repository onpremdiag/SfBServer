# Federation is not working (OnPrem deployment)
**Owner:** João Loureiro

# Description

This scenario checks if Skype for Business Server federation in scope of a pure On Premises
deployment is functional and properly configured. For more details please refer to the
following article
- [Managing federation and external access to Skype for Business Server](https://docs.microsoft.com/en-us/skypeforbusiness/manage/federation-and-external-access/managing-federation-and-external-access)

[[_TOC_]]

# Execution flow<br/>

::: mermaid
graph LR

Parameter1[\Parameter1\] -.-> Scenario(Scenario)
Parameter2[\Parameter2\] -.-> Scenario(Scenario)
Parameter3[\Parameter3\] -.-> Scenario(Scenario)
Scenario --> Analyzer1(Analyzer1)
Analyzer1 --> Rule1(Rule1)
Rule1 --> Insight1(Insight1)
Rule1 --> Insight2(Insight2)
Insight1 --> Detection(Detection)
Insight1 --> Action(Action)
Insight2 --> ...(...)
:::
___
::: mermaid
graph LR

%%
%% Scenario Name: SDOnPremFederation
%% Date Generated: 8/18/2021 11:51:07 AM
%% This file is autogenerated. Please do not edit directly
%%

	PDEdgeUserID[\PDEdgeUserID\] -.-> SDOnPremFederation
	PDEdgePassword[\PDEdgePassword\] -.-> SDOnPremFederation
	PDRemoteFqdnDomain[\PDRemoteFqdnDomain\] -.-> SDOnPremFederation

	SDOnPremFederation(SDOnPremFederation) --1--> ADCertificateCheck[ADCertificateCheck]

	ADCertificateCheck -- 1.1 --> RDCheckEdgeCerts[RDCheckEdgeCerts]
	ADCertificateCheck -- 1.2 --> RDCheckMisplacedRootCACertificates[RDCheckMisplacedRootCACertificates]
	ADCertificateCheck -- 1.3 --> RDCheckTooManyCertsRootCA[RDCheckTooManyCertsRootCA]
	SDOnPremFederation --2 --> ADCheckEdgeInternalDNS[ADCheckEdgeInternalDNS]

	ADCheckEdgeInternalDNS -- 2.1 --> RDCheckEdgeInternalDNS[RDCheckEdgeInternalDNS]
	SDOnPremFederation --3 --> ADCheckEdgeOnPremConfiguration[ADCheckEdgeOnPremConfiguration]

	ADCheckEdgeOnPremConfiguration -- 3.1 --> RDEdgeConfigAllowFederatedUsers[RDEdgeConfigAllowFederatedUsers]
	ADCheckEdgeOnPremConfiguration -- 3.2 --> RDEdgeConfigAllowOutsideUsers[RDEdgeConfigAllowOutsideUsers]
	SDOnPremFederation --4 --> ADCheckEdgePoolConfiguration[ADCheckEdgePoolConfiguration]

	ADCheckEdgePoolConfiguration -- 4.1 --> RDCheckCMSReplicationStatus[RDCheckCMSReplicationStatus]
	ADCheckEdgePoolConfiguration -- 4.2 --> RDCheckEdgePoolCount[RDCheckEdgePoolCount]
	SDOnPremFederation --5 --> ADCheckFederatedDomain[ADCheckFederatedDomain]

	ADCheckFederatedDomain -- 5.1 --> RDCheckDomainApprovedForFederation[RDCheckDomainApprovedForFederation]
	SDOnPremFederation --6 --> ADCheckFederationDNSRecords[ADCheckFederationDNSRecords]

	ADCheckFederationDNSRecords -- 6.1 --> RDCheckEdgeExternalDNS[RDCheckEdgeExternalDNS]
	ADCheckFederationDNSRecords -- 6.2 --> RDCheckLocalDomainFederationDNSRecord[RDCheckLocalDomainFederationDNSRecord]
	SDOnPremFederation --7 --> ADCheckSIPHostingProviderForOnPrem[ADCheckSIPHostingProviderForOnPrem]

	ADCheckSIPHostingProviderForOnPrem -- 7.1 --> RDCheckProxyFQDN[RDCheckProxyFQDN]
	ADCheckSIPHostingProviderForOnPrem -- 7.2 --> RDCheckSharedAddressSpaceNotEnabled[RDCheckSharedAddressSpaceNotEnabled]
	ADCheckSIPHostingProviderForOnPrem -- 7.3 --> RDCheckVerificationLevel[RDCheckVerificationLevel]
	ADCheckSIPHostingProviderForOnPrem -- 7.4 --> RDIsHostingProviderEnabled[RDIsHostingProviderEnabled]
	SDOnPremFederation --8 --> ADEdgeServerAvailable[ADEdgeServerAvailable]

	ADEdgeServerAvailable -- 8.1 --> RDEdgeServerAvailable[RDEdgeServerAvailable]
	ADEdgeServerAvailable -- 8.2 --> RDEdgeServerListening[RDEdgeServerListening]
	SDOnPremFederation --9 --> ADIsSfbServerAdminAccount[ADIsSfbServerAdminAccount]

	ADIsSfbServerAdminAccount -- 9.1 --> RDCheckSfbServerAccountAdminRights[RDCheckSfbServerAccountAdminRights]

:::

# Rule specifications
### R1 - RDCheckCMSReplicationStatus
- Determine if Central Management Store replication is up to date<br/>
``` powershell
    $CMSReplicationStatus = Get-CsManagementStoreReplicationStatus
    $EdgePools            = Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort}
    $EdgeServers          = @()

    if ($null -ne $EdgePools)
    {
        foreach ($EdgePool in $EdgePools)
        {
            $computer = Get-CsComputer | Where-Object {$_.Pool -eq $EdgePools.PoolFqdn}

            if ($null -ne $computer)
            {
                $EdgeServers += $computer.Fqdn
            }
        }

        if (-not [String]::IsNullOrEmpty($EdgeServers))
        {
            if (-not [String]::IsNullOrEmpty($CMSReplicationStatus))
            {
                foreach ($EdgeServer in $EdgeServers)
                {
                    $replicationStatus = ($CMSReplicationStatus | Where-Object {$_.ReplicaFqdn -eq $EdgeServer}).UpToDate
                    $replicationDate   = ($CMSReplicationStatus | Where-Object {$_.ReplicaFqdn -eq $EdgeServer}).LastStatusReport

                    if (-not $replicationStatus)
                    {
                        $this.Insight.Name      = 'IDCMSReplicationNotSuccessful'
                        $this.Insight.Detection = ($global:InsightDetections.($this.Insight.Name) -f $EdgeServer)
                        $this.Insight.Action    = ($global:InsightActions.($this.Insight.Name) -f $replicationDate)
                        $this.Success           = $false
                        break
                    }
                }
            }
            else
            {
                # No information returned from Get-CsManagementStoreReplicationStatus
                throw 'IDNoReplicationStatus'
            }
        }
        else
        {
            throw 'IDNoEdgeServersFound'
        }
```

### R2 - RDCheckDomainApprovedForFederation
- Determine if open federation is enabled or target domain is approved for federation<br/>
``` powershell
    $EdgeConfiguration = Get-CsAccessEdgeConfiguration
    $RemoteDomainFqdn  = Get-ParameterDefinition -Object $this -ParameterName 'PDRemoteFqdnDomain'

    if ($EdgeConfiguration.EnablePartnerDiscovery)
    {
        $BlockedDomain    = Get-CsBlockedDomain | Where-Object {$_.Domain -eq $RemoteDomainFqdn }

        if (-not [string]::IsNullOrEmpty($BlockedDomain))
        {
            $this.Success           = $false
            $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f $RemoteDomainFqdn
            $this.Insight.Action    = $global:InsightActions.($this.Insight.Name) -f $RemoteDomainFqdn
        }
    }
    else
    {
        $AllowedDomain    = Get-CsAllowedDomain | Where-Object {$_.Domain -eq $RemoteDomainFqdn }

        if ([string]::IsNullOrEmpty($AllowedDomain))
        {
            $this.Success           = $false
            $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f $RemoteDomainFqdn
            $this.Insight.Action    = $global:InsightActions.($this.Insight.Name) -f $RemoteDomainFqdn
        }
    }
```

### R3 - RDCheckEdgeCerts
- Determine if Edge servers external certificate meet basic requirements<br/>
``` powershell
    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

            foreach ($edgeServer in $edgeServers)
            {
                if(-not (Test-NetConnection -ComputerName $edgeServer -Port $global:WinRMHTTPPort).TcpTestSucceeded)
                {
                    throw 'IDEdgeServerNotReachable'
                }
                else
                {
                    $Session = New-PSSession -ComputerName $edgeServer `
                                                -Credential $obj.Credential `
                                                -Port $global:WinRMHTTPPort `
                                                -ErrorAction SilentlyContinue

                    if (-not [string]::IsNullOrEmpty($Session))
                    {
                        $scriptBlock =
                        {
                            Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                            Get-CsCertificate -Type AccessEdgeExternal | `
                            Select-Object -Property PsComputerName, AlternativeNames, Thumbprint, Use
                        }

                        $edgeCerts = Invoke-RemoteCommand -Session $Session `
                                                            -ScriptBlock $scriptBlock

                        if(-not [string]::IsNullOrEmpty($edgeCerts))
                        {
                            foreach($edgeCert in $edgeCerts)
                            {
                                $Identity  = $edgeCert.PsComputerName
                                $PoolFQDN  = (Get-CsComputer -Identity $Identity).Pool
                                $FQDN      = (Get-CsService -EdgeServer -PoolFqdn $PoolFQDN).AccessEdgeExternalFqdn
                                $SANOnCert = Test-SanOnCert -SAN $FQDN -Certificate $edgeCert

                                if(-not $SANOnCert)
                                {
                                    throw 'IDEdgeCertsNotOnSan'
                                }
                                else
                                {
                                    $this.Success = $true
                                }
                            }
                            $this.Results += @{EdgeCerts=$edgeCerts}
                        }
                        else
                        {
                            throw 'IDUnableToConnect'
                        }
                    }
                    else
                    {
                        throw 'IDUnableToConnect'
                    }
                }
            }
        }
    }
    else
    {
        throw 'IDGetCsServiceFails'
    }
```

### R4 - RDCheckEdgeExternalDNS
- Determine if edge server allows external DNS resolution<br/>
``` powershell
    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

            if (-not [string]::IsNullOrEmpty($edgeServers))
            {
                foreach ($edgeServer in $edgeServers)
                {
                    if(-not (Test-NetConnection -ComputerName $edgeServer -Port $global:WinRMHTTPPort).TcpTestSucceeded)
                    {
                        throw 'IDEdgeServerNotReachable'
                    }
                    else
                    {
                        $Session = New-PSSession -ComputerName $edgeServer `
                                                    -Credential $obj.Credential `
                                                    -Port $global:WinRMHTTPPort `
                                                    -ErrorAction SilentlyContinue

                        if (-not [string]::IsNullOrEmpty($Session))
                        {
                            $scriptBlock =
                            {
                                Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                                Resolve-DnsName -Name sipfed.online.lync.com -Type A -DnsOnly | Where-Object {$_.Section -eq 'Answer'}
                            }

                            $dnsRecords = Invoke-RemoteCommand -Session $Session `
                                                                -ScriptBlock $scriptBlock

                            if(-not [string]::IsNullOrEmpty($dnsRecords))
                            {
                                $this.Success = $true
                            }
                            else
                            {
                                throw 'IDExternalDNSResolutionFailed'
                            }
                        }
                        else
                        {
                            throw 'IDUnableToConnect'
                        }
                    }
                }
            }
            else
            {
                throw 'IDNoEdgeServersFound'
            }
        }
    }
    else
    {
        throw 'IDGetCsServiceFails'
    }
```

### R5 - RDCheckEdgeInternalDNS
- Determine if edge server can resolve next hop pool FQDN for each frontend server<br/>
``` powershell
    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $registrar = ($edgePool.Registrar).Split(':')[1]
            $edgeServer = ($edgePool.Identity).Split(':')[1]

            if ((-not [string]::IsNullOrEmpty($registrar)) -and (-not [string]::IsNullOrEmpty($edgeServer)))
            {
                $pool = Get-CsComputer -Pool $registrar

                $Session = New-PSSession -ComputerName $edgeServer `
                                            -Credential $obj.Credential `
                                            -Port $global:WinRMHTTPPort `
                                            -ErrorAction SilentlyContinue

                if (-not [string]::IsNullOrEmpty($Session))
                {
                    foreach ($frontEndServer in $pool)
                    {
                        $scriptBlock =
                        {
                            Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                            Resolve-DnsName -Name $Using:frontEndServer.Fqdn -Type A -DnsOnly |
                                Where-Object {$_.Section -eq 'Answer'} | Select-Object -Property IPAddress
                        }

                        $dnsRecord = Invoke-RemoteCommand -Session $Session `
                                                    -ScriptBlock $scriptBlock

                        if (-not [string]::IsNullOrEmpty($dnsRecord))
                        {
                            $IPAddress = $dnsRecord.IPAddress

                            if (-not [string]::IsNullOrEmpty($IPAddress))
                            {
                                # Let's check to see if that IPAddress resolves to server Fqdn
                                $scriptBlock =
                                {
                                    Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                                    ([System.Net.Dns]::GetHostEntry($Using:IPAddress)).HostName
                                }

                                $serverName = Invoke-RemoteCommand -Session $Session `
                                                    -ScriptBlock $scriptBlock

                                # Server name returned should match the frontend server name from earlier
                                if ($frontEndServer.Fqdn -ne $serverName)
                                {
                                    throw 'IDIPv4DoesNotMatchReverseLookup'
                                }
                            }
                            else
                            {
                                # Record found but no IP address associated with it
                                throw 'IDNoIPAddressForHostName'
                            }
                        }
                        else
                        {
                            #no dns record found
                            throw 'IDNoDNSRecordFound'
                        }
                    }
                }
                else
                {
                    throw 'IDUnableToConnect'
                }
            }
            else
            {
                #no registrar server found
                throw 'IDNoRegistrarServerFound'
            }
        }
    }
    else
    {
        # no edge pools found
        throw 'IDNoEdgePoolsFound'
    }
```

### R6 - RDCheckEdgePoolCount
- Determine if just one edge pool is enabled for federation<br/>
``` powershell
    New-Variable -Name SIPSecurePort `
                 -Value 5061 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        if ($EdgePools.Count -ne 1)
        {
            $this.Success = $false
        }
    }

### RDCheckLocalDomainFederationDNSRecord
- Determine if local domain federation DNS SRV record is discoverable<br/>
``` powershell
    New-Variable -Name WinRMHTTPSPort `
                 -Value 5986 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    New-Variable -Name SIPSecurePort `
                 -Value 5061 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $SipDomains = Get-CsSipDomain | Where-Object {$_.IsDefault}

    if ([string]::IsNullOrEmpty($SipDomains))
    {
        throw 'IDNoDefaultSipDomainFound'
    }

    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

            foreach ($edgeServer in $edgeServers)
            {
                if(-not (Test-NetConnection -ComputerName $edgeServer -Port $global:WinRMHTTPPort).TcpTestSucceeded)
                {
                    throw 'IDEdgeServerNotReachable'
                }
                else
                {
                    foreach ($sipDomain in $SipDomains)
                    {
                        $Session = New-PSSession -ComputerName $edgeServer `
                                                    -Credential $obj.Credential `
                                                    -Port $global:WinRMHTTPPort `
                                                    -ErrorAction SilentlyContinue

                        $scriptBlock =
                        {
                            param($Server)
                            Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                            Resolve-DnsName -Name $Server -Type SRV -DnsOnly | Where-Object {$_.Type -eq 'SRV'}
                        }

                        $dnsRecords = Invoke-RemoteCommand -Session $Session `
                                        -ScriptBlock $scriptBlock `
                                        -ArgumentList ("{0}.{1}" -f $global:SIPFederationTLS, $sipDomain.Identity)

                        $errorRecords = $Error | Where-Object {$_.ToString() -like "*$($global:SIPFederationTLS).$($sipDomain.Identity)"}

                        if(-not [string]::IsNullOrEmpty($dnsRecords))
                        {
                            foreach($dnsRecord in $dnsRecords)
                            {
                                $NameTarget  = $dnsRecord.NameTarget

                                if ($NameTarget.EndsWith($sipDomain.Identity))
                                {
                                    $scriptBlock =
                                    {
                                        param($Server)
                                        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                                        (Resolve-DnsName -Name $Server -DnsOnly | Where-Object {$_.Section -eq 'Answer'}).Name
                                    }

                                    $dnsRecordName = Invoke-RemoteCommand -Session $Session `
                                                                            -ScriptBlock $scriptBlock `
                                                                            -ArgumentList $NameTarget

                                    if(-not [string]::IsNullOrEmpty($dnsRecordName))
                                    {
                                        $this.Success = $true
                                    }
                                    else
                                    {
                                        throw 'IDUnableToResolveDNSName'
                                    }
                                }
                                else
                                {
                                    $this.Success        = $false
                                    $this.Insight.Action = $this.Insight.Action -f $sipDomain.Identity
                                    break
                                }
                            }
                        }
                        elseif (-not [string]::IsNullOrEmpty($errorRecords))
                        {
                            if ($errorRecords.Exception.ToString().Contains("DNS name does not exist"))
                            {
                                throw 'IDDNSNameDoesNotExist'
                            }
                        }
                        else
                        {
                            throw 'IDUnableToConnectToSipServer'
                        }
                    }
                }
            }
        }
    }
    else
    {
        throw 'IDGetCsServiceFails'
    }

### RDCheckMisplacedRootCACertificates
- Determine if there are misplaced certificates in local machine Root system store<br/>
``` powershell
    New-Variable -Name LocalMachineCertificateStore `
                 -Description "This type of certificate store is local to the computer and is global to all users on the computer. This certificate store is located in the registry under the HKEY_LOCAL_MACHINE root." `
                 -Value 'Cert:\LocalMachine\Root' `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    if (Test-Path -Path $global:LocalMachineCertificateStore)
    {
        $nonRootCertificates = Get-Childitem $global:LocalMachineCertificateStore -Recurse | Where-Object {$_.Issuer -ne $_.Subject}

        if (@($nonRootCertificates).count -gt 0)
        {
            $this.Success           = $false
            $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f @($nonRootCertificates).count.ToString()
        }
    }
    else
    {
        # Somehow, the certificate store is not being found. This is a PROBLEM!
        $this.Insight.Detection = $global:InsightDetections.'IDLocalCertStoreNotFound'
        $this.Insight.Action    = $global:InsightActions.'IDLocalCertStoreNotFound'
        $this.Success           = $false
    }
```

### R7 - RDCheckLocalDomainFederationDNSRecord
- Determine if local domain federation DNS SRV record is discoverable
``` powershell
    try
    {
        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

        $SipDomains = Get-CsSipDomain | Where-Object {$_.IsDefault}

        if ([string]::IsNullOrEmpty($SipDomains))
        {
            throw 'IDNoDefaultSipDomainFound'
        }

        $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

        if (-not [string]::IsNullOrEmpty($EdgePools))
        {
            foreach ($edgePool in $EdgePools)
            {
                $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

                foreach ($edgeServer in $edgeServers)
                {
                    if(-not (Test-NetConnection -ComputerName $edgeServer -Port $global:WinRMHTTPPort).TcpTestSucceeded)
                    {
                        throw 'IDEdgeServerNotReachable'
                    }
                    else
                    {
                        foreach ($sipDomain in $SipDomains)
                        {
                            $Session = New-PSSession -ComputerName $edgeServer `
                                                        -Credential $obj.Credential `
                                                        -Port $global:WinRMHTTPPort `
                                                        -ErrorAction SilentlyContinue

                            $scriptBlock =
                            {
                                param($Server)
                                Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                                Resolve-DnsName -Name $Server -Type SRV -DnsOnly | Where-Object {$_.Type -eq 'SRV'}
                            }

                            $dnsRecords = Invoke-RemoteCommand -Session $Session `
                                            -ScriptBlock $scriptBlock `
                                            -ArgumentList ("{0}.{1}" -f $global:SIPFederationTLS, $sipDomain.Identity)

                            $errorRecords = $Error | Where-Object {$_.ToString() -like "*$($global:SIPFederationTLS).$($sipDomain.Identity)"}

                            if(-not [string]::IsNullOrEmpty($dnsRecords))
                            {
                                foreach($dnsRecord in $dnsRecords)
                                {
                                    $NameTarget  = $dnsRecord.NameTarget

                                    if ($NameTarget.EndsWith($sipDomain.Identity))
                                    {
                                        $scriptBlock =
                                        {
                                            param($Server)
                                            Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force;
                                            (Resolve-DnsName -Name $Server -DnsOnly | Where-Object {$_.Section -eq 'Answer'}).Name
                                        }

                                        $dnsRecordName = Invoke-RemoteCommand -Session $Session `
                                                                                -ScriptBlock $scriptBlock `
                                                                                -ArgumentList $NameTarget

                                        if(-not [string]::IsNullOrEmpty($dnsRecordName))
                                        {
                                            $this.Success = $true
                                        }
                                        else
                                        {
                                            throw 'IDUnableToResolveDNSName'
                                        }
                                    }
                                    else
                                    {
                                        $this.Success        = $false
                                        $this.Insight.Action = $this.Insight.Action -f $sipDomain.Identity
                                        break
                                    }
                                }
                            }
                            elseif (-not [string]::IsNullOrEmpty($errorRecords))
                            {
                                if ($errorRecords.Exception.ToString().Contains("DNS name does not exist"))
                                {
                                    throw 'IDDNSNameDoesNotExist'
                                }
                            }
                            else
                            {
                                throw 'IDUnableToConnectToSipServer'
                            }
                        }
                    }
                }
            }
        }
        else
        {
            throw 'IDGetCsServiceFails'
```

### R8 - RDCheckMisplacedRootCACertificates
- Determine if there are misplaced certificates in local machine Root system store
``` powershell
    try
    {
        Set-Variable -Name ProgressPreference -Scope 'Global' -Value "SilentlyContinue" -Force

        if (Test-Path -Path $global:LocalMachineCertificateStore)
        {
            $nonRootCertificates = Get-Childitem $global:LocalMachineCertificateStore -Recurse | Where-Object {$_.Issuer -ne $_.Subject}

            if (@($nonRootCertificates).count -gt 0)
            {
                $this.Success           = $false
                $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f @($nonRootCertificates).count.ToString()
            }
        }
        else
        {
            # Somehow, the certificate store is not being found. This is a PROBLEM!
            $this.Insight.Detection = $global:InsightDetections.'IDLocalCertStoreNotFound'
            $this.Insight.Action    = $global:InsightActions.'IDLocalCertStoreNotFound'
            $this.Success           = $false
        }
    }
```

### R9 - RDCheckProxyFQDN
- Determine if the Office 365 hosting provider ProxyFqdn is correct<br/>
``` powershell
    New-Variable -Name SIPProxyFQDN `
                 -Value "sipfed.online.lync.com" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $HostingProvider = Get-CsHostingProvider | Where-Object {$_.ProxyFqdn -eq $global:SIPProxyFQDN }

    if (-not $HostingProvider)
    {
        $this.Success = $false
    }
```

### R10 - RDCheckSfbServerAccountAdminRights
- Determine if current account has Skype for Business Server administrative privileges<br/>
``` powershell
    $this.Success = Test-IsSkypeForBusinessServerAdminAccount

    New-Variable -Name SfBServerCsAdminGroup `
             -Description "" `
                 -Value "CsAdministrator" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    New-Variable -Name SfBServerCsServerAdminGroup `
                 -Description "" `
                 -Value "CsServerAdministrator" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    New-Variable -Name SfBServerRTCAdminGroup `
                 -Description "" `
                 -Value "RTCUniversalServerAdmins" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    function Test-IsSkypeForBusinessServerAdminAccount
    {
        $IsServerAdminAccount = $false

        foreach ($group in $global:SfBServerCsAdminGroup, $global:SfBServerCsServerAdminGroup, $global:SfBServerRTCAdminGroup)
        {
            $IsServerAdminAccount = $IsServerAdminAccount -or (Test-IsADGroupMember $group)
            if ($IsServerAdminAccount)
            {
                break
            }
        }

        return $IsServerAdminAccount
    }

    function Test-IsADGroupMember
    {
        param
        (
            [Parameter(Mandatory = $true)]
            [string] $group
        )

        return ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole($group)

    }
```

### R11 - RDCheckSharedAddressSpaceNotEnabled
- Determine if the SkypeforBusinessOnline hosting provider SharedAddressSpace is disabled<br/>
``` powershell
    New-Variable -Name SIPProxyFQDN `
                 -Value "sipfed.online.lync.com" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $HostingProvider = Get-CsHostingProvider | Where-Object {$_.ProxyFqdn -eq $global:SIPProxyFQDN }

    if ($HostingProvider)
    {
        if ($HostingProvider.EnabledSharedAddressSpace)
        {
            throw $this.Insight.Name
        }
    }
    else
    {
        throw "IDNoSIPProxyFqdnFound"
    }
```

### R12 - RDCheckTooManyCertsRootCA
- Determine if there are too many certificates in local machine root CA store<br/>
``` powershell
    New-Variable -Name LocalMachineCertificateStore `
                 -Description "This type of certificate store is local to the computer and is global to all users on the computer. This certificate store is located in the registry under the HKEY_LOCAL_MACHINE root." `
                 -Value 'Cert:\LocalMachine\Root' `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    New-Variable -Name MaxNumberOfRootCertificates `
                 -Value 100 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    if (Test-Path -Path $global:LocalMachineCertificateStore)
    {
        $certificates = Get-ChildItem -Path $global:LocalMachineCertificateStore -ErrorAction SilentlyContinue

        if($null -ne $certificates)
        {
            if ($certificates.Count -gt $global:MaxNumberOfRootCertificates)
            {
                $this.Success           = $false
                $this.Insight.Detection = $global:InsightDetections.($this.Insight.Name) -f ($certificates.Count).ToString()
                $this.Insight.Action    = $global:InsightActions.($this.Insight.Name) -f $global:MaxNumberOfRootCertificates
            }
        }
        else
        {
            # No certificates found
            $this.Insight.Detection = $global:InsightDetections.'IDNoCertificatesFound'
            $this.Insight.Action    = $global:InsightActions.'IDNoCertificatesFound'
            $this.Success           = $false
        }
    }
    else
    {
        # Somehow, the certificate store is not being found. This is a PROBLEM!
        $this.Insight.Detection = $global:InsightDetections.'IDLocalCertStoreNotFound'
        $this.Insight.Action    = $global:InsightActions.'IDLocalCertStoreNotFound'
        $this.Success           = $false
    }
```

### R13 - RDCheckVerificationLevel
- Determine if the SIP hosting provider messages verification level is set correctly<br/>
``` powershell
    New-Variable -Name SIPProxyFQDN `
                 -Value "sipfed.online.lync.com" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $HostingProvider = Get-CsHostingProvider | Where-Object {$_.ProxyFqdn -eq $global:SIPProxyFQDN }

    if (-not $HostingProvider)
    {
        $this.Success = $false
    }
    else
    {
        $this.Success = $HostingProvider.VerificationLevel -eq 'UseSourceVerification'
    }
```

### R14 - RDEdgeConfigAllowFederatedUsers
- Determine if remote user access is enabled<br/>
``` powershell
    $EdgeConfiguration = Get-CsAccessEdgeConfiguration
    $this.Success      = $EdgeConfiguration.AllowFederatedUsers
```

### R15 - RDEdgeConfigAllowOutsideUsers
- Determine if the edge configuration allows outside users<br/>
``` powershell
    $EdgeConfiguration = Get-CsAccessEdgeConfiguration
    $this.Success      = $EdgeConfiguration.AllowOutsideUsers
```

### R16 - RDEdgeServerAvailable
- Determine if the edge server is reachable (ping)<br/>
``` powershell
    New-Variable -Name SIPSecurePort `
                 -Value 5061 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

            foreach ($edgeServer in $edgeServers)
            {
                $available = Test-ConnectionLocalSubnet -ComputerName $edgeServer

                if([string]::IsNullOrEmpty($available) -or -not $available)
                {
                    throw 'IDEdgeServerNotListening'
                }
            }
        }
    }
    else
    {
        throw 'IDGetCsServiceFails'
    }
```

### R17 - RDEdgeServerListening
- Determine if the edge server is listening on port 5985<br/>
``` powershell
    New-Variable -Name WinRMHTTPPort `
                 -Value 5985 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force
    New-Variable -Name SIPSecurePort `
                 -Value 5061 `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $EdgePools = @(Get-CsService -EdgeServer | Where-Object {$_.AccessEdgeExternalSipPort -eq $global:SIPSecurePort})

    if (-not [string]::IsNullOrEmpty($EdgePools))
    {
        foreach ($edgePool in $EdgePools)
        {
            $edgeServers = (Get-CsPool -Identity $edgePool.PoolFqdn).Computers

            foreach ($edgeServer in $edgeServers)
            {
                if(-not (Test-NetConnection -ComputerName $edgeServer -Port $global:WinRMHTTPPort).TcpTestSucceeded)
                {
                    $this.Success = $false
                    $this.Insight.Detection = $this.Insight.Detection -f $edgeServer
                    break
                }
            }
        }
    }
    else
    {
        $this.Success = $false
    }
```

### R18 - RDIsHostingProviderEnabled
- Determine if hosting provider required to communicate with Skype for Business Online is enabled<br/>
``` powershell
    New-Variable -Name SIPProxyFQDN `
                 -Value "sipfed.online.lync.com" `
                 -Scope 'Global' `
                 -Option ReadOnly `
                 -Force

    $HostingProvider = Get-CsHostingProvider | Where-Object {$_.ProxyFqdn -eq $global:SIPProxyFQDN }

    if (-not $HostingProvider.Enabled -or $HostingProvider.Enabled -eq $false)
    {
        $this.Success = $false
    }
```

# Messages
When particular rule detects an issue (return value is false) an **Insight detection**
and an **Insight Action** are displayed in addition to an **Analyzer message** and **Rule description**.
For more details, see example below:

(...)
<span style="color:green">[+] Verifies if target domain is approved for federation **-> Analyzer message**
&nbsp;&nbsp;&nbsp;&nbsp;[+] Determine if open federation is enabled or target domain is approved for federation **-> Rule message**</span>
<span style="color:red">[-] Verifies the on-premise domains configuration match Office 365 tenant domain configuration **-> Analyzer message**
&nbsp;&nbsp;&nbsp;&nbsp;[-] Determine if the on-premise domains configuration match Office 365 tenant domain configuration **-> Rule message**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-] Detection : The allowed federated domain configured in your On Premise environment, '[Domain not found]', and your O365 Tenant, 'domainnotinonprem.com', do not match. **-> Insight detection message**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[-] Action : Please review Allowed domains list in the on-premises deployment as that must exactly match the Allowed domains list for your online tenant. For more information please refer to the following article https://docs.microsoft.com/en-us/skypeforbusiness/hybrid/plan-hybrid-connectivity. **-->Insight action message**</span>
(...)

### Scenario Description
| **Language** | **Name** | **Description** |
|:----------|:------|:-------------|
| en-US | SDOnPremFederation | Federation is not working (On-Premises deployment)


### Parameter description, prompt and example
| **#** | **Language** | **Name** | **Description** | **Prompt** | **Example** |
|:------|:----------|:------|:-------------|:----- |:-----|
| P1 | en-US | PDEdgePassword | The password associated with your Skype for Business Edge server username | Skype for Business Edge server admin password |  |
| P2 | en-US | PDEdgeUserID | The admin username for the Skype for Business Edge | Skype for Business Edge server admin username | user1@contoso.com | user1 |
| P3 | en-US | PDRemoteFqdnDomain | Fully qualified domain name (FQDN) of the federated domain | Remote federated domain (FQDN) | domain.contoso.com | contoso.com |


### Analyzer Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:----------|:------|:-------------|
| A1 | en-US | ADCertificateCheck | Verifies if Edge servers external certificate meet basic requirements|
| A2 | en-US | ADCheckEdgeInternalDNS | Verifies if the edge server can resolve the next hop pool FQDN for each frontend|
| A3 | en-US | ADCheckEdgeOnPremConfiguration | Verifies the edge pool configuration for On-Premise deployment|
| A4 | en-US | ADCheckEdgePoolConfiguration | Verifies the edge pool configuration is correct|
| A5 | en-US | ADCheckFederatedDomain | Verifies if target domain is approved for federation|
| A6 | en-US | ADCheckFederationDNSRecords | Verifies the federation DNS records requirements|
| A7 | en-US | ADCheckSIPHostingProviderForOnPrem | Verifies the SIP Hosting Provider settings for On-Premise deployment|
| A8 | en-US | ADEdgeServerAvailable | Verifies that the Edge Server is available for remote PowerShell connections|
| A9 | en-US | ADIsSfbServerAdminAccount | Verifies if account has Skype for Business Server administrative privileges|


### Rule Descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| R1 | en-US | RDCheckCMSReplicationStatus | Determine if Central Management Store replication is up to date |
| R2 | en-US | RDCheckDomainApprovedForFederation | Determine if open federation is enabled or target domain is approved for federation |
| R3 | en-US | RDCheckEdgeCerts | Determine if Edge servers external certificate meet basic requirements |
| R4 | en-US | RDCheckEdgeExternalDNS | Determine if edge server allows external DNS resolution |
| R5 | en-US | RDCheckEdgeInternalDNS | Determine if edge server can resolve next hop pool FQDN for each frontend server |
| R6 | en-US | RDCheckEdgePoolCount | Determine if just one edge pool is enabled for federation |
| R7 | en-US | RDCheckLocalDomainFederationDNSRecord | Determine if local domain federation DNS SRV record is discoverable |
| R8 | en-US | RDCheckMisplacedRootCACertificates | Determine if there are misplaced certificates in local machine Root system store |
| R9 | en-US | RDCheckProxyFQDN | Determine if the Office 365 hosting provider ProxyFqdn is correct |
| R10 | en-US | RDCheckSfbServerAccountAdminRights | Determine if current account has Skype for Business Server administrative privileges |
| R11 | en-US | RDCheckSharedAddressSpaceNotEnabled | Determine if the SkypeforBusinessOnline hosting provider SharedAddressSpace is disabled |
| R12 | en-US | RDCheckTooManyCertsRootCA | Determine if there are too many certificates in local machine root CA store |
| R13 | en-US | RDCheckVerificationLevel | Determine if the SIP hosting provider messages verification level is set correctly |
| R14 | en-US | RDEdgeConfigAllowFederatedUsers | Determine if remote user access is enabled |
| R15 | en-US | RDEdgeConfigAllowOutsideUsers | Determine if the edge configuration allows outside users |
| R16 | en-US | RDEdgeServerAvailable | Determine if the edge server is reachable (ping) |
| R17 | en-US | RDEdgeServerListening | Determine if the edge server is listening on port 5985 |
| R18 | en-US | RDIsHostingProviderEnabled | Determine if hosting provider required to communicate with Skype for Business Online is enabled |


### Insight detection descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| ID1 | en-US | IDDNSNameDoesNotExist | The DNS name, '{0}', does not appear to exist |
| ID2 | en-US | IDEdgeCertsNotOnSan | Unable to find FQDN '{1}' on the edge server '{0}' external certificate subject alternative name list. |
| ID3 | en-US | IDEdgeServerNotListening | The edge server, '{0}', is not listening on the remote TCP port 5985. |
| ID4 | en-US | IDEdgeServerNotReachable | The edge server, '{0}', is not returning the echo response replies to the ICMP echo requests packets or pings. |
| ID5 | en-US | IDEdgeServerWrongExternalSipPort | Unable to validate the port being used for External SIP connections. Either the edge server is unreachable or the port has the incorrect value. |
| ID6 | en-US | IDExternalDNSResolutionFailed | Attempting to resolve sipfed.online.lync.com DNS A record failed. |
| ID7 | en-US | IDGetCsServiceFails | Unable to return information about the services and server roles being used in your Skype for Business Server infrastructure |
| ID8 | en-US | IDIPv4DoesNotMatchReverseLookup | DNS IPv4 name does not match reverse DNS IP address {0} lookup. Expected: {1}, Actual: {2} |
| ID9 | en-US | IDNoDefaultSipDomainFound | Unable to locate any information regarding SIP domains. |
| ID10 | en-US | IDNoDNSRecordFound | No DNS record was found. |
| ID11 | en-US | IDNoEdgePoolsFound | No Edge pools were found. |
| ID12 | en-US | IDNoEdgeServersFound | No edge server was found for this configuration. |
| ID13 | en-US | IDNoIPAddressForHostName | A DNS record was found for '{0}', but there is no IP address associated with it |
| ID14 | en-US | IDNoRegistrarServerFound | No Registrar server is configured as next hop pool for the {0} Edge Server pool. |
| ID15 | en-US | IDNoReplicationStatus | Unable to get information about the Skype for Business Server replication process. This includes information on whether replication is currently up to date for your Skype for Business Server computers. |
| ID16 | en-US | IDUnableToConnect | Unable to connect to server '{0}'. The most likely cause of this issue is that either the server is unreachable or the user does not have the required permissions. |
| ID17 | en-US | IDUnableToConnectToEdgeServer | Unable to connect to edge server '{0}'. The most likely cause of this issue is that either the server is unreachable or the user does not have the required permissions. |
| ID18 | en-US | IDUnableToResolveDNSName | Unable to resolve DNS query for one or more of your Skype for Business Server server(s). |


### Insight action descriptions
| **#** | **Language** | **Name** | **Description** |
|:------|:---------|:-----|:------------|
| IA1 | en-US | IDDNSNameDoesNotExist | Please verify that the domain name, '{0}', is correct and attempt this operation again. |
| IA2 | en-US | IDEdgeCertsNotOnSan | Please make sure that external edge certificate subject alternative name list contains all FQDNs of all SIP enabled domains and the same certificate is being used on each Edge Server in the Edge pool. For more information please refer to https://docs.microsoft.com/skypeforbusiness/plan-your-deployment/edge-server-deployments/edge-environmental-requirements#CertPlan and https://docs.microsoft.com/skypeforbusiness/hybrid/cloud-consolidation-edge-certificates. |
| IA3 | en-US | IDEdgeServerNotListening | Remote PowerShell needs to be enabled on the edge server and confirm TCP port 5985 is not being blocked by the firewall. For more information please refer to the following article https://docs.microsoft.com/powershell/module/Microsoft.PowerShell.Core/Enable-PSRemoting?view=powershell-5.1. |
| IA4 | en-US | IDEdgeServerNotReachable | Please check if edge server is available and there are no connectivity issues. For more information please refer to the following article https://docs.microsoft.com/powershell/module/microsoft.powershell.management/test-connection?view=powershell-7. |
| IA5 | en-US | IDEdgeServerWrongExternalSipPort | Please confirm Edge Pool is enabled for listening on TCP port 5061. |
| IA6 | en-US | IDExternalDNSResolutionFailed | Please check if Skype for Business Edge Server public DNS server is configured and external DNS resolution is functional. |
| IA7 | en-US | IDGetCsServiceFails | Please verify that the edge server you are querying is reachable and that the 'AccessEdgeExternalSipPort' is set to 5061. |
| IA8 | en-US | IDIPv4DoesNotMatchReverseLookup | Please verify if the DNS record entry is correct as hosts files entries. |
| IA9 | en-US | IDNoDefaultSipDomainFound | Please confirm that 'Get-CsSipDomain | Where-Object {$_.IsDefault}' cmdlet returns a non-empty result. |
| IA10 | en-US | IDNoDNSRecordFound | Please add a Pool FQDN DNS Record. For DNS Load Balancing all Front Servers in this Pool should be added. |
| IA11 | en-US | IDNoEdgePoolsFound | Please open Skype for Business Server Topology Builder and confirm if an Edge pool has been configured. |
| IA12 | en-US | IDNoEdgeServersFound | Please confirm that at least one Edge Server Pool has been configured. |
| IA13 | en-US | IDNoIPAddressForHostName | Please verify that the following PowerShell command 'Resolve-DnsName -Name '{0}' -Type A' returns a valid IP address. |
| IA14 | en-US | IDNoRegistrarServerFound | Please configure the next hop pool for the '{0}' Edge Pool. |
| IA15 | en-US | IDNoReplicationStatus | Please verify if Get-CsManagementStoreReplicationStatus cmdlet returns a non-empty output. |
| IA16 | en-US | IDUnableToConnect | Please verify that the destination server, '{0}', is reachable and that the user has permission to access the server remotely. |
| IA17 | en-US | IDUnableToConnectToEdgeServer | Please run the following and attempt again: Set-Item wsman:\localhost\client\TrustedHosts -Value {0} -Force |
| IA18 | en-US | IDUnableToResolveDNSName | Please confirm that 'Resolve-DnsName' cmdlet successfully performs a DNS query for each Edge Server in the Edge pool and each Frontend in the Frontend pool. |
